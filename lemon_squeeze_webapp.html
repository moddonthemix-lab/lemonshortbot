<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçã Lemon Squeeze Web App v2.0</title>
    <style>
        :root {
            /* Light mode colors */
            --bg-gradient-start: #FFD700;
            --bg-gradient-end: #FFA500;
            --container-bg: #FFF9E6;
            --text-primary: #333;
            --text-secondary: #666;
            --card-bg: white;
            --border-color: #FFD700;
            --settings-bg: #FFE97F;
            --shadow: rgba(0,0,0,0.1);
            --shadow-heavy: rgba(0,0,0,0.3);
        }
        
        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #0f3460;
            --text-primary: #eee;
            --text-secondary: #ccc;
            --card-bg: #1a1a2e;
            --border-color: #FFA500;
            --settings-bg: #16213e;
            --shadow: rgba(0,0,0,0.3);
            --shadow-heavy: rgba(0,0,0,0.5);
        }
        
        /* Fix text colors in dark mode for info boxes */
        [data-theme="dark"] .settings-panel div[style*="background: #FFE97F"],
        [data-theme="dark"] .settings-panel div[style*="background:#FFE97F"] {
            background: #2d3748 !important;
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .settings-panel div[style*="background: white"],
        [data-theme="dark"] .settings-panel div[style*="background:white"],
        [data-theme="dark"] .pattern-info div[style*="background: white"],
        [data-theme="dark"] .pattern-info div[style*="background:white"] {
            background: #1a202c !important;
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .settings-panel ul,
        [data-theme="dark"] .settings-panel p,
        [data-theme="dark"] .settings-panel li,
        [data-theme="dark"] .settings-panel strong {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .pattern-info strong,
        [data-theme="dark"] .pattern-info p {
            color: #e2e8f0 !important;
        }
        
        /* Fix summary stats text in dark mode */
        [data-theme="dark"] .results-header p {
            color: #cbd5e0 !important;
        }
        
        /* Fix inline styled elements in dark mode */
        [data-theme="dark"] div[style*="color: #666"],
        [data-theme="dark"] div[style*="color:#666"],
        [data-theme="dark"] span[style*="color: #666"],
        [data-theme="dark"] p[style*="color: #666"] {
            color: #cbd5e0 !important;
        }
        
        [data-theme="dark"] div[style*="color: #999"],
        [data-theme="dark"] p[style*="color: #999"] {
            color: #a0aec0 !important;
        }
        
        /* Fix "no results" message */
        [data-theme="dark"] .no-results p {
            color: #cbd5e0 !important;
        }
        
        /* Make sure orange colors pop in dark mode */
        [data-theme="dark"] .settings-panel h2,
        [data-theme="dark"] .metric-section h4 {
            color: #fb923c !important;
        }
        
        /* Improve readability of all paragraph text in dark mode */
        [data-theme="dark"] p,
        [data-theme="dark"] li,
        [data-theme="dark"] span:not(.stat-value):not(.metric-value) {
            color: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow-heavy);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            padding: 40px;
            text-align: center;
            position: relative;
        }
        
        /* Toolbar - Desktop */
        .toolbar {
            background: var(--card-bg);
            padding: 15px 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 10px var(--shadow);
            border-bottom: 2px solid var(--border-color);
        }
        
        /* Floating actions - Hidden on desktop, shown on mobile */
        .floating-actions {
            display: none;
        }
        
        /* Dark Mode Toggle */
        .dark-mode-toggle {
            background: var(--settings-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .dark-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow);
            background: var(--border-color);
        }
        
        /* Favorites Button */
        .favorites-toggle {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
        }
        
        .favorites-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.5);
        }
        
        .favorites-count {
            background: white;
            color: #FFA500;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .header::before, .header::after {
            content: "üçã";
            position: absolute;
            font-size: 100px;
            opacity: 0.1;
            top: 20px;
        }
        
        .header::before { left: 50px; }
        .header::after { right: 50px; }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p {
            font-size: 1.3em;
            font-style: italic;
            opacity: 0.9;
        }
        
        .badge {
            display: inline-block;
            background: #FF6B6B;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Market Timer */
        .market-timer {
            background: var(--card-bg);
            padding: 15px 40px;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 2px 10px var(--shadow);
        }

        .market-timer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .market-timer-icon {
            font-size: 1.4em;
        }

        .market-timer-time {
            color: #4CAF50;
            font-family: 'Courier New', monospace;
            font-size: 1.3em;
        }

        .market-timer-label {
            color: var(--text-secondary);
        }

        .market-closed .market-timer-time {
            color: #FF6B6B;
        }

        .market-open .market-timer-time {
            color: #4CAF50;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            justify-content: center;
            background: var(--settings-bg);
            padding: 0;
            margin: 0;
        }
        
        .tab-button {
            flex: 1;
            max-width: 200px;
            padding: 18px 15px;
            background: transparent;
            border: none;
            font-size: 1.05em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            border-bottom: 4px solid transparent;
        }
        
        .tab-button:hover {
            background: var(--card-bg);
            opacity: 0.8;
        }
        
        .tab-button.active {
            background: var(--container-bg);
            color: #FFA500;
            border-bottom: 4px solid #FFA500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .content {
            padding: 40px;
        }
        
        .settings-panel {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px var(--shadow);
            color: var(--text-primary);
        }
        
        .settings-panel h2 {
            color: #FFA500;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        input[type="number"] {
            padding: 12px;
            border: 3px solid var(--border-color);
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text-primary);
        }
        
        select {
            padding: 12px;
            border: 3px solid var(--border-color);
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            background: var(--card-bg);
            cursor: pointer;
            color: var(--text-primary);
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #FFA500;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .scan-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .scan-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            border: none;
            padding: 25px 60px;
            font-size: 28px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(255, 165, 0, 0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .scan-button:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 165, 0, 0.6);
        }
        
        .scan-button:active {
            transform: translateY(-2px);
        }
        
        .scan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.2em;
            color: #666;
            font-weight: 600;
        }
        
        .results {
            display: none;
        }
        
        .results.active {
            display: block;
        }
        
        .results-header {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px var(--shadow);
            text-align: center;
            color: var(--text-primary);
        }
        
        .results-header h2 {
            color: #FFA500;
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #FFA500;
        }
        
        .stat-label {
            font-size: 1em;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .stock-card, .pattern-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
            color: var(--text-primary);
            position: relative;
        }
        
        .stock-card:hover, .pattern-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }
        
        /* Add to Favorites Button */
        .favorite-btn {
            background: transparent;
            border: 3px solid #FFA500;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .favorite-btn:hover {
            background: #FFA500;
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.5);
        }
        
        .favorite-btn.active {
            background: #FFA500;
            border-color: #FF8C00;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
        }
        
        /* Chart Container */
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
            background: var(--container-bg);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .stock-title-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .stock-ticker {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .stock-company {
            font-size: 1.2em;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .risk-badge {
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .risk-extreme {
            background: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .risk-high {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF4444 100%);
            color: white;
        }
        
        .risk-good {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .risk-moderate {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .metric-section {
            background: var(--settings-bg);
            padding: 15px;
            border-radius: 10px;
        }
        
        .metric-section h4 {
            color: #FFA500;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .metric-item:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .metric-value {
            color: var(--text-primary);
            font-weight: bold;
        }
        
        .pattern-info {
            background: var(--settings-bg);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .pattern-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        
        .pattern-bullish {
            background: #10b981;
            color: white;
        }
        
        .pattern-bearish {
            background: #ef4444;
            color: white;
        }
        
        .no-results {
            background: var(--card-bg);
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow);
            color: var(--text-primary);
        }
        
        .no-results h3 {
            font-size: 2em;
            color: #FFA500;
            margin-bottom: 20px;
        }
        
        /* Favorites Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-heavy);
            color: var(--text-primary);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .modal-header h2 {
            color: #FFA500;
            font-size: 2em;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-primary);
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: var(--settings-bg);
            transform: rotate(90deg);
        }
        
        .favorite-item {
            background: var(--settings-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .favorite-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .favorite-info {
            flex: 1;
        }
        
        .favorite-ticker {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .favorite-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .favorite-actions {
            display: flex;
            gap: 10px;
        }
        
        .favorite-scan-btn, .favorite-remove-btn {
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .favorite-scan-btn {
            background: #10b981;
            color: white;
        }
        
        .favorite-scan-btn:hover {
            background: #059669;
            transform: scale(1.05);
        }
        
        .favorite-remove-btn {
            background: #ef4444;
            color: white;
        }
        
        .favorite-remove-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        /* Win Rate Badge */
        .win-rate-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .win-rate-high {
            background: #10b981;
            color: white;
        }
        
        .win-rate-medium {
            background: #FFA500;
            color: white;
        }
        
        .win-rate-low {
            background: #ef4444;
            color: white;
        }
        
        .win-rate-new {
            background: #666;
            color: white;
        }
        
        .disclaimer {
            background: #FF6B6B;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            line-height: 1.6;
        }
        
        [data-theme="dark"] .disclaimer {
            background: #991b1b;
            color: #fee2e2;
        }
        
        /* Authentication Styles */
        .auth-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }
        
        .profile-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .profile-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }
        
        .profile-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: white;
            color: #8b5cf6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        
        .auth-modal.active {
            display: flex;
        }
        
        .auth-modal-content {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px var(--shadow-heavy);
            color: var(--text-primary);
            position: relative;
        }
        
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            color: #10b981;
            border-bottom: 3px solid #10b981;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }
        
        .auth-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .auth-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .auth-close:hover {
            background: var(--settings-bg);
            transform: rotate(90deg);
        }
        
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 250px;
            z-index: 1000;
            overflow: hidden;
        }
        
        .profile-dropdown.active {
            display: block;
        }
        
        .profile-header {
            padding: 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
        }
        
        .profile-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .profile-email {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .profile-menu {
            padding: 10px 0;
        }
        
        .profile-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-menu-item:hover {
            background: var(--settings-bg);
        }
        
        .profile-menu-item.danger {
            color: #ef4444;
        }
        
        .profile-menu-item.danger:hover {
            background: #fee2e2;
        }
        
        [data-theme="dark"] .profile-menu-item.danger:hover {
            background: #991b1b;
        }
        
        .auth-container {
            position: relative;
        }
        
        @media (max-width: 768px) {
            .auth-modal-content {
                padding: 30px 20px;
            }
            
            .profile-dropdown {
                right: -10px;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .header::before, .header::after {
                display: none;
            }
            
            /* Hide toolbar on mobile */
            .toolbar {
                display: none;
            }
            
            /* Show floating buttons on mobile */
            .floating-actions {
                display: flex;
                position: fixed;
                bottom: 20px;
                right: 20px;
                flex-direction: column;
                gap: 12px;
                z-index: 1000;
            }
            
            /* Auth button mobile styles */
            .floating-actions .auth-button {
                border-radius: 50%;
                width: 56px;
                height: 56px;
                padding: 0;
                font-size: 1.4em;
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.5);
            }
            
            .floating-actions .auth-button span:not(:first-child) {
                display: none;
            }
            
            .floating-actions .profile-button {
                border-radius: 50%;
                width: 56px;
                height: 56px;
                padding: 0;
                position: relative;
            }
            
            .floating-actions .profile-button > span:not(.profile-avatar) {
                display: none;
            }
            
            .floating-actions .profile-avatar {
                width: 100%;
                height: 100%;
                font-size: 1.5em;
            }
            
            /* Profile dropdown positioning for mobile */
            .profile-dropdown {
                position: fixed;
                top: auto;
                bottom: 90px;
                right: 20px;
                left: 20px;
                margin: 0;
                max-width: calc(100vw - 40px);
            }
            
            .floating-actions .dark-mode-toggle {
                border-radius: 50%;
                width: 56px;
                height: 56px;
                padding: 0;
                font-size: 1.4em;
                box-shadow: 0 4px 20px var(--shadow-heavy);
            }
            
            .floating-actions .dark-mode-toggle:hover {
                transform: scale(1.1) rotate(10deg);
            }
            
            .floating-actions .dark-mode-toggle #darkModeText {
                display: none;
            }
            
            .floating-actions .favorites-toggle {
                border-radius: 50%;
                width: 56px;
                height: 56px;
                padding: 0;
                font-size: 1.6em;
                position: relative;
                box-shadow: 0 4px 20px rgba(255, 165, 0, 0.5);
            }
            
            .floating-actions .favorites-toggle:hover {
                transform: scale(1.1);
            }
            
            .floating-actions .favorites-toggle > span:not(.favorites-count) {
                display: none;
            }
            
            .floating-actions .favorites-toggle::before {
                content: '‚≠ê';
                font-size: 1em;
            }
            
            .floating-actions .favorites-count {
                position: absolute;
                top: -5px;
                right: -5px;
                background: #ef4444;
                border: 2px solid white;
                width: 22px;
                height: 22px;
                font-size: 0.7em;
            }
            
            .scan-button {
                padding: 20px 40px;
                font-size: 20px;
            }
            
            .stock-ticker {
                font-size: 1.5em;
            }
            
            .tab-button {
                font-size: 0.9em;
                padding: 15px 10px;
            }
            
            /* Auth modal mobile adjustments */
            .auth-modal-content {
                padding: 30px 20px;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçã Lemon Squeeze v2.0</h1>
            <p>Multi-Timeframe Scanner: Stocks & Crypto</p>
            <span class="badge">v2.0 - Hourly ‚Ä¢ Daily ‚Ä¢ Weekly ‚Ä¢ Crypto</span>
        </div>

        <!-- Market Timer -->
        <div class="market-timer" id="marketTimer">
            <div class="market-timer-content">
                <span class="market-timer-icon">‚è±Ô∏è</span>
                <span class="market-timer-time" id="marketTimerTime">--:--:--</span>
                <span class="market-timer-label" id="marketTimerLabel">until close</span>
            </div>
        </div>

        <!-- Toolbar with actions -->
        <div class="toolbar">
            <button class="favorites-toggle" onclick="toggleFavoritesModal()">
                <span>‚≠ê</span>
                <span>Favorites</span>
                <span class="favorites-count" id="favoritesCount">0</span>
            </button>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeToggle">
                <span id="darkModeIcon">üåô</span>
                <span id="darkModeText">Dark</span>
            </button>
            
            <!-- Auth Container -->
            <div class="auth-container">
                <button class="auth-button" id="authButton" onclick="openAuthModal()" style="display: flex;">
                    <span>üë§</span>
                    <span>Sign In</span>
                </button>
                <button class="profile-button" id="profileButton" onclick="toggleProfileDropdown()" style="display: none;">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <span id="profileName">User</span>
                    <span>‚ñº</span>
                </button>
                
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-header">
                        <div class="profile-name" id="dropdownName">User Name</div>
                        <div class="profile-email" id="dropdownEmail">user@email.com</div>
                    </div>
                    <div class="profile-menu">
                        <div class="profile-menu-item" onclick="viewProfile()">
                            <span>üë§</span>
                            <span>My Profile</span>
                        </div>
                        <div class="profile-menu-item" onclick="viewSettings()">
                            <span>‚öôÔ∏è</span>
                            <span>Settings</span>
                        </div>
                        <div class="profile-menu-item" onclick="viewHistory()">
                            <span>üìä</span>
                            <span>Trading Journal</span>
                        </div>
                        <div class="profile-menu-item danger" onclick="signOut()">
                            <span>üö™</span>
                            <span>Sign Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('squeeze')">
                üçã Short Squeeze
            </button>
            <button class="tab-button" onclick="switchTab('hourly')">
                ‚è∞ Hourly Plays
            </button>
            <button class="tab-button" onclick="switchTab('daily')">
                üìà Daily Plays
            </button>
            <button class="tab-button" onclick="switchTab('weekly')">
                üìä Weekly Plays
            </button>
            <button class="tab-button" onclick="switchTab('crypto')">
                ‚Çø Crypto
            </button>
            <button class="tab-button" onclick="switchTab('volemon')">
                üîä Volemon
            </button>
            <button class="tab-button" onclick="switchTab('usuals')">
                ‚≠ê Usuals
            </button>
            <button class="tab-button" onclick="switchTab('lemonai')">
                ü§ñ LemonAI
            </button>
            <button class="tab-button" onclick="switchTab('challenges')">
                üèÜ Challenges
            </button>
            <button class="tab-button" onclick="switchTab('lemonade')">
                ü•§ Lemonade Stand
            </button>
            <button class="tab-button" onclick="switchTab('howto')">
                üìö How to Use
            </button>
        </div>
        
        <!-- Short Squeeze Tab -->
        <div id="squeezeTab" class="tab-content active">
            <div class="content">
                <div class="settings-panel">
                    <h2>‚öôÔ∏è Scan Settings</h2>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="minShort">Min Short Interest %</label>
                            <input type="number" id="minShort" value="25" step="1" min="0">
                        </div>
                        <div class="setting-item">
                            <label for="minGain">Min Daily Gain %</label>
                            <input type="number" id="minGain" value="15" step="1" min="0">
                        </div>
                        <div class="setting-item">
                            <label for="minVolRatio">Min Volume Ratio</label>
                            <input type="number" id="minVolRatio" value="1.5" step="0.1" min="0">
                        </div>
                        <div class="setting-item">
                            <label for="minRisk">Min Risk Score</label>
                            <input type="number" id="minRisk" value="60" step="1" min="0" max="100">
                        </div>
                    </div>
                </div>
                
                <div class="scan-section">
                    <button id="scanButton" class="scan-button" onclick="startSqueezeScan()">
                        üîç SCAN FOR SQUEEZES üçã
                    </button>
                </div>
                
                <div id="squeezeLoading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Squeezing lemons... üçã</div>
                </div>
                
                <div id="squeezeResults" class="results"></div>
                
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER</strong>
                    This tool is for informational and educational purposes only. Short squeezes are extremely high-risk and volatile. 
                    Past performance does not guarantee future results. Always conduct your own research (DYOR) and never invest more 
                    than you can afford to lose. This is NOT financial advice!
                </div>
            </div>
        </div>
        
        <!-- Hourly Plays Tab -->
        <div id="hourlyTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>üìö The 3-1 Strat Pattern (Hourly Timeframe)</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8; font-size: 1.1em;">
                            <li><strong>"3" = Outside Bar:</strong> Higher high + lower low than previous hour (expansion)</li>
                            <li><strong>"1" = Inside Bar:</strong> Lower high + higher low than previous hour (consolidation)</li>
                            <li><strong>Setup:</strong> Hourly patterns signal potential intraday moves</li>
                        </ul>
                        <p style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-style: italic;">
                            ‚è∞ Hourly scans are perfect for day trading - catch quick moves!
                        </p>
                    </div>
                </div>
                
                <div class="scan-section">
                    <button id="hourlyButton" class="scan-button" onclick="startHourlyScan()">
                        ‚è∞ SCAN HOURLY PATTERNS üéØ
                    </button>
                </div>
                
                <div id="hourlyLoading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Squeezing hourly lemons... üçã‚è∞</div>
                </div>
                
                <div id="hourlyResults" class="results"></div>
                
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER</strong>
                    Hourly patterns are for active traders. Intraday moves can be volatile and unpredictable.
                    Always use proper risk management, set stop losses, and never risk more than you can afford to lose. This is NOT financial advice!
                </div>
            </div>
        </div>
        
        <!-- Daily Plays Tab -->
        <div id="dailyTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>üìö The 3-1 Strat Pattern</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8; font-size: 1.1em;">
                            <li><strong>"3" = Outside Bar:</strong> Higher high + lower low than previous candle (expansion)</li>
                            <li><strong>"1" = Inside Bar:</strong> Lower high + higher low than previous candle (consolidation)</li>
                            <li><strong>Setup:</strong> When a "1" follows a "3", it signals consolidation before a potential breakout</li>
                        </ul>
                        <p style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-style: italic;">
                            üí° This scanner checks 100+ popular stocks + high short interest stocks for this pattern
                        </p>
                    </div>
                </div>
                
                <div class="scan-section">
                    <button id="dailyButton" class="scan-button" onclick="startDailyScan()">
                        üìà SCAN ALL PATTERNS üéØ
                    </button>
                </div>
                
                <div id="dailyLoading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Squeezing 3 lemons a day... üçãüçãüçã</div>
                </div>
                
                <div id="dailyResults" class="results"></div>
                
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER</strong>
                    Technical patterns are educational tools, not guarantees. Markets are unpredictable and pattern failures are common.
                    Always use proper risk management, set stop losses, and never risk more than you can afford to lose. This is NOT financial advice!
                </div>
            </div>
        </div>
        
        <!-- Weekly Plays Tab -->
        <div id="weeklyTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>üìö The 3-1 Strat Pattern (Weekly Timeframe)</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8; font-size: 1.1em;">
                            <li><strong>"3" = Outside Bar:</strong> Higher high + lower low than previous week (expansion)</li>
                            <li><strong>"1" = Inside Bar:</strong> Lower high + higher low than previous week (consolidation)</li>
                            <li><strong>Setup:</strong> Weekly patterns signal potential multi-day/week moves</li>
                        </ul>
                        <p style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-style: italic;">
                            üí° Weekly scans look for larger timeframe setups - these can signal bigger moves!
                        </p>
                    </div>
                </div>
                
                <div class="scan-section">
                    <button id="weeklyButton" class="scan-button" onclick="startWeeklyScan()">
                        üìä SCAN WEEKLY PATTERNS üéØ
                    </button>
                </div>
                
                <div id="weeklyLoading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Squeezing weekly lemons... üçãüìä</div>
                </div>
                
                <div id="weeklyResults" class="results"></div>
                
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER</strong>
                    Technical patterns are educational tools, not guarantees. Weekly patterns suggest larger moves but markets are unpredictable.
                    Always use proper risk management, set stop losses, and never risk more than you can afford to lose. This is NOT financial advice!
                </div>
            </div>
        </div>
        
        <!-- Crypto Tab -->
        <div id="cryptoTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>‚Çø Crypto 3-1 Strat Scanner</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>Scanning:</strong> BTC, ETH, XRP, SOL, DOGE, HYPE</p>
                        <ul style="margin-left: 20px; line-height: 1.8; font-size: 1.1em;">
                            <li><strong>Multi-Timeframe:</strong> Checks hourly, daily, AND weekly patterns</li>
                            <li><strong>Crypto-Specific:</strong> 24/7 markets with unique volatility</li>
                            <li><strong>Quick Signals:</strong> Find patterns across all major cryptos instantly</li>
                        </ul>
                        <p style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-style: italic;">
                            ‚Çø Crypto patterns can signal explosive moves - trade with caution!
                        </p>
                    </div>
                </div>
                
                <div class="scan-section">
                    <button id="cryptoButton" class="scan-button" onclick="startCryptoScan()">
                        ‚Çø SCAN CRYPTO PATTERNS üöÄ
                    </button>
                </div>
                
                <div id="cryptoLoading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Squeezing crypto lemons... üçã‚Çø</div>
                </div>
                
                <div id="cryptoResults" class="results"></div>
                
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER</strong>
                    Cryptocurrency trading is extremely high-risk and volatile. Prices can swing dramatically in minutes.
                    Never invest more than you can afford to lose. This is NOT financial advice!
                </div>
            </div>
        </div>
        
        <!-- Volemon Tab -->
        <div id="volemonTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>üîä Volemon - Volume Monster Scanner</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>Auto-Scanner:</strong> Runs every 20 minutes automatically!</p>
                        <ul style="margin-left: 20px; line-height: 1.8; font-size: 1.1em;">
                            <li><strong>2x Volume:</strong> Finds stocks with 2x or more their average volume</li>
                            <li><strong>Auto-Only:</strong> No manual scanning needed - just watch the results</li>
                            <li><strong>Smart Timer:</strong> Countdown shows when next scan runs</li>
                        </ul>
                        <p style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-style: italic;">
                            üîä Volume spikes can signal big moves - Volemon catches them for you!
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 10px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3 style="margin-bottom: 5px;">üîÑ Scanner Status: ACTIVE</h3>
                                <p style="opacity: 0.9;">Next scan: <span id="volemonTimer" style="font-family: monospace; font-weight: bold;">20:00</span></p>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="totalScans">0</div>
                                <div style="opacity: 0.9;">Total Scans Today</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="stocksFound">0</div>
                                <div style="opacity: 0.9;">Stocks Found</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <p style="margin: 0; opacity: 0.9;">Last scan: <span id="lastScan">Never</span></p>
                            <button onclick="clearVolemonResults()" style="background: rgba(239, 68, 68, 0.8); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background='rgba(239, 68, 68, 1)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.8)'">
                                üóëÔ∏è Clear All Results
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="volemonLoading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Volemon hunting volume monsters... üîäüçã</div>
                </div>
                
                <div id="volemonResults" class="results"></div>
                
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER</strong>
                    High volume doesn't guarantee profits. Volume spikes can be due to news, earnings, or other factors.
                    Always do your own research. This is NOT financial advice!
                </div>
            </div>
        </div>
        
        <!-- Usuals Tab -->
        <div id="usualsTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>‚≠ê The Usuals - Your Watchlist</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>Tracking:</strong> SOFI, INTC, SPY, TSLA, COIN, CDE, PLTR, AAPL, BAC, NVDA, GOOGL, META, MSFT, UNH</p>
                        <ul style="margin-left: 20px; line-height: 1.8; font-size: 1.1em;">
                            <li><strong>Auto-Updates:</strong> Scans every 15 minutes automatically</li>
                            <li><strong>Multi-Timeframe:</strong> Shows 3-1 patterns on Daily, Weekly, Hourly, 4H</li>
                            <li><strong>Volume Analysis:</strong> Current vs average volume with percentage</li>
                            <li><strong>Top News:</strong> Latest 2 headlines per stock (no fluff!)</li>
                        </ul>
                        <p style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-style: italic;">
                            ‚≠ê Your go-to stocks, always monitored, always updated!
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3 style="margin-bottom: 5px;">üîÑ Scanner Status: ACTIVE</h3>
                                <p style="opacity: 0.9;">Next scan: <span id="usualsTimer" style="font-family: monospace; font-weight: bold;">15:00</span></p>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="usualsTotalScans">0</div>
                                <div style="opacity: 0.9;">Scans Today</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="usualsPatterns">0</div>
                                <div style="opacity: 0.9;">Patterns Found</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <p style="margin: 0; opacity: 0.9;">Last update: <span id="usualsLastScan">Never</span></p>
                        </div>
                    </div>
                </div>
                
                <div id="usualsLoading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Scanning your usuals... ‚≠êüçã</div>
                </div>
                
                <div id="usualsResults" class="results"></div>
                
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER</strong>
                    This is for informational purposes only. Stock prices are volatile and past performance doesn't guarantee future results.
                    Always do your own research. This is NOT financial advice!
                </div>
            </div>
        </div>

        <!-- LemonAI Tab -->
        <div id="lemonaiTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>ü§ñ LemonAI - AI-Powered Options Recommendations</h2>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <p style="font-size: 1.3em; font-weight: bold; margin-bottom: 15px;">
                            üß† Intelligent Options Analysis
                        </p>
                        <p style="font-size: 1.1em; line-height: 1.6; margin-bottom: 10px;">
                            LemonAI analyzes patterns, volume, news sentiment, and market conditions to suggest high-probability options trades.
                        </p>
                        <p style="font-size: 0.95em; opacity: 0.9;">
                            ‚ö†Ô∏è <strong>Educational Tool Only:</strong> This is NOT financial advice. LemonAI uses technical analysis and heuristics.
                            Always do your own research and consult a financial advisor before trading options.
                        </p>
                    </div>
                </div>

                <div class="scan-section">
                    <button id="lemonaiButton" class="scan-button" onclick="startLemonAIScan()">
                        üîÑ REFRESH RECOMMENDATIONS NOW
                    </button>
                    <p style="text-align: center; color: #666; margin-top: 15px; font-size: 0.95em;">
                        üîî <strong>Auto-Scanning Active:</strong> Scans at market open (9:30 AM ET) + every 15 min during market hours
                    </p>
                    <p style="text-align: center; color: #10b981; margin-top: 5px; font-size: 0.9em; font-weight: bold;">
                        üëÅÔ∏è Real-time monitoring: New plays appear automatically when detected!
                    </p>
                </div>

                <!-- Win/Loss Statistics Panel - ALWAYS VISIBLE -->
                <div id="lemonaiStatsPanel" style="margin: 30px 0;">
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 1.5em;">üìä Performance Tracker (Last 30 Days)</h3>

                        <!-- No Data Message (shows initially, hidden when data loads) -->
                        <div id="statsNoData" style="background: rgba(255,255,255,0.15); padding: 25px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.8em; margin-bottom: 15px;">üîÑ Building Performance Data...</div>
                            <div style="font-size: 1.1em; line-height: 1.6; opacity: 0.9;">
                                The system is now tracking all recommendations!<br>
                                Win/loss statistics will appear here after 7 days when trades are checked.<br><br>
                                <strong>üìÖ Check back in a week to see your accuracy!</strong>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.95em;">
                                <strong>How it works:</strong><br>
                                ‚Ä¢ Day 1-6: Collecting trade data<br>
                                ‚Ä¢ Day 7+: Win/loss stats calculated and displayed here<br>
                                ‚Ä¢ Updates daily with latest performance
                            </div>
                        </div>

                        <!-- Stats Content (hidden initially, shows when data loads) -->
                        <div id="statsContent" style="display: none;">
                            <!-- Overall Stats -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;" id="statsWinRate">--%</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">Win Rate</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #6ee7b7;" id="statsWins">--</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">Wins</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #fca5a5;" id="statsLosses">--</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">Losses</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold;" id="statsTotalTrades">--</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">Total Trades</div>
                                </div>
                            </div>

                            <!-- Best Patterns -->
                            <div id="statsByPattern" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                <div style="font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">üéØ Best Performing Patterns:</div>
                                <div id="statsPatternList" style="font-size: 0.95em;">
                                    <div style="opacity: 0.7;">Loading pattern statistics...</div>
                                </div>
                            </div>

                            <!-- Timeframe Performance -->
                            <div id="statsByTimeframe" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                                <div style="font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">‚è∞ Performance by Holding Period:</div>
                                <div id="statsTimeframeList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                                    <div style="opacity: 0.7;">Loading timeframe stats...</div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 15px; font-size: 0.85em; opacity: 0.8;" id="statsLastUpdated">
                                Last updated: --
                            </div>
                        </div>
                    </div>
                </div>

                <div id="lemonaiLoading" class="loading">
                    <div class="loading-spinner"></div>
                    <p>üß† AI is analyzing patterns, news, and market conditions...</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 10px;">This may take a moment</p>
                </div>

                <div id="lemonaiResults"></div>

                <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 12px; margin-top: 30px;">
                    <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Important Disclaimer</h3>
                    <p style="color: #856404; line-height: 1.6;">
                        LemonAI is an <strong>educational tool</strong> that uses technical analysis to suggest potential options trades.
                        The AI considers patterns, volume, news sentiment, and market conditions, but <strong>CANNOT predict the future</strong>.<br><br>

                        Options trading carries significant risk and is not suitable for all investors. You can lose your entire investment.
                        This tool is for educational purposes only and does not constitute financial advice.<br><br>

                        Always conduct your own research, understand the risks, and consult with a licensed financial advisor before making any trades.
                    </p>
                </div>
            </div>
        </div>

        <!-- Challenges Tab -->
        <div id="challengesTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>üèÜ Trading Challenges</h2>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 25px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <p style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                            üéØ Test Your Skills & Compete!
                        </p>
                        <p style="font-size: 1.1em; line-height: 1.6;">
                            Complete trading challenges to improve your skills and compete with other traders. Track your progress and earn achievements!
                        </p>
                    </div>

                    <!-- Multi-Week Challenges -->
                    <div id="multiWeekChallengeSection" style="margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="margin: 0 0 15px 0; font-size: 1.4em;">üéØ Multi-Week Challenges</h3>
                            <div id="multiWeekChallengeContent">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2em; margin-bottom: 10px;">Loading multi-week challenges...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Challenges -->
                    <div id="weeklyChallengeSection" style="margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h3 style="margin: 0 0 15px 0; font-size: 1.4em;">‚ö° Weekly Challenges</h3>
                            <div id="weeklyChallengeContent">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.2em; margin-bottom: 10px;">Loading weekly challenges...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Challenge Progress -->
                    <div id="challengeProgressSection">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #3b82f6;">
                            <h3 style="margin: 0 0 15px 0; font-size: 1.3em; color: #3b82f6;">üìä Your Progress</h3>
                            <div id="challengeProgressContent">
                                <div style="text-align: center; padding: 20px; color: #666;">
                                    Start completing challenges to track your progress!
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="loadChallenges()" class="scan-button" style="margin-top: 20px;">
                        üîÑ Refresh Challenges
                    </button>
                </div>
            </div>
        </div>

        <!-- Lemonade Stand Tab -->
        <div id="lemonadeTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>ü•§ Lemonade Stand - Dividend Income</h2>
                    <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 25px; border-radius: 15px; color: white; margin-bottom: 20px;">
                        <p style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                            üí∞ Build Your Passive Income Stream
                        </p>
                        <p style="font-size: 1.1em; line-height: 1.6;">
                            Discover the top dividend-paying stocks and see how much monthly income you can generate from a $1,000 investment.
                        </p>
                    </div>

                    <!-- Monthly Income Calculator -->
                    <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.4em;">üíµ Income Calculator</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">$1,000 Investment</div>
                                <div style="font-size: 2em; font-weight: bold;" id="monthlyIncome1k">$--</div>
                                <div style="font-size: 0.85em; opacity: 0.8;">per month</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Annual Yield</div>
                                <div style="font-size: 2em; font-weight: bold;" id="avgYield">--%</div>
                                <div style="font-size: 0.85em; opacity: 0.8;">average</div>
                            </div>
                        </div>
                    </div>

                    <!-- Dividend Stocks -->
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #6366f1; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em; color: #6366f1;">üèÜ Dividend Stocks (Ranked by Yield)</h3>
                        <div id="dividendStocksList">
                            <div style="text-align: center; padding: 20px; color: #666;">
                                Loading dividend stocks...
                            </div>
                        </div>
                    </div>

                    <!-- Dividend Chart -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em; color: #333;">üìà Yield Comparison Chart</h3>
                        <canvas id="dividendChart" style="max-height: 400px;"></canvas>
                    </div>

                    <!-- Dividend News -->
                    <div style="background: rgba(234, 88, 12, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #ea580c; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em; color: #ea580c;">üì∞ Dividend News</h3>
                        <div id="dividendNewsList">
                            <div style="text-align: center; padding: 20px; color: #666;">
                                Loading dividend news...
                            </div>
                        </div>
                    </div>

                    <button onclick="loadDividendData()" class="scan-button">
                        üîÑ Refresh Dividend Data
                    </button>
                </div>
            </div>
        </div>

        <!-- How to Use Tab -->
        <div id="howtoTab" class="tab-content">
            <div class="content">
                <div class="settings-panel">
                    <h2>üìö Welcome to Lemon Squeeze!</h2>
                    <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 25px; border-radius: 15px; color: #333; margin-bottom: 30px;">
                        <p style="font-size: 1.3em; font-weight: bold; margin-bottom: 15px;">
                            üçã Your All-in-One Stock & Crypto Pattern Scanner
                        </p>
                        <p style="font-size: 1.1em; line-height: 1.6;">
                            Lemon Squeeze scans the market for high-probability trading setups using the proven <strong>3-1 Strat pattern</strong>. 
                            Whether you're hunting short squeezes, tracking your favorite stocks, or monitoring crypto, we've got you covered!
                        </p>
                    </div>
                </div>

                <!-- Quick Start Guide -->
                <div class="settings-panel">
                    <h2>üöÄ Quick Start Guide</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <div style="display: grid; gap: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #10b981;">
                                <h3 style="color: #10b981; margin-bottom: 10px;">1Ô∏è‚É£ Choose Your Scanner</h3>
                                <p style="color: #333; line-height: 1.6;">
                                    Pick from <strong>7 different scanners</strong> at the top:
                                </p>
                                <ul style="margin: 10px 0 0 20px; color: #333; line-height: 1.8;">
                                    <li><strong>üçã Short Squeeze:</strong> Find stocks with high short interest gaining momentum</li>
                                    <li><strong>‚è∞ Hourly Plays:</strong> Intraday patterns for day traders</li>
                                    <li><strong>üìà Daily Plays:</strong> Swing trade setups on daily charts</li>
                                    <li><strong>üìä Weekly Plays:</strong> Position trade setups for larger moves</li>
                                    <li><strong>‚Çø Crypto:</strong> Bitcoin, Ethereum, and major altcoin patterns</li>
                                    <li><strong>üîä Volemon:</strong> Auto-scans every 20 min for volume spikes</li>
                                    <li><strong>‚≠ê Usuals:</strong> Your watchlist, auto-updated every 15 min</li>
                                </ul>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #8b5cf6;">
                                <h3 style="color: #8b5cf6; margin-bottom: 10px;">2Ô∏è‚É£ Click Scan & Wait</h3>
                                <p style="color: #333; line-height: 1.6;">
                                    Hit the big scan button and let Lemon Squeeze do the heavy lifting! Scans take 30-90 seconds depending on the tab.
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #f59e0b;">
                                <h3 style="color: #f59e0b; margin-bottom: 10px;">3Ô∏è‚É£ Review Results</h3>
                                <p style="color: #333; line-height: 1.6;">
                                    Stocks appear ranked by quality. Each card shows:
                                </p>
                                <ul style="margin: 10px 0 0 20px; color: #333; line-height: 1.8;">
                                    <li>Pattern type and direction (bullish/bearish)</li>
                                    <li>Current price and change percentage</li>
                                    <li>Volume analysis</li>
                                    <li>Interactive TradingView chart</li>
                                    <li>‚≠ê Favorite button to save stocks you like</li>
                                </ul>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #ef4444;">
                                <h3 style="color: #ef4444; margin-bottom: 10px;">4Ô∏è‚É£ Do Your Own Research!</h3>
                                <p style="color: #333; line-height: 1.6; font-weight: bold;">
                                    ‚ö†Ô∏è CRITICAL: Lemon Squeeze finds setups, but YOU must verify them. Check fundamentals, news, and risk management before trading!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- The 3-1 Strat Explained -->
                <div class="settings-panel">
                    <h2>üéØ The 3-1 Strat Pattern - Master Class</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <p style="font-size: 1.2em; color: #333; margin-bottom: 20px; line-height: 1.6;">
                            The <strong>3-1 Strat</strong> is a powerful price action pattern that identifies consolidation after expansion - 
                            a classic setup that traders have used for decades to catch breakouts.
                        </p>

                        <!-- Pattern Components -->
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #FFA500; margin-bottom: 15px;">üìä Pattern Components</h3>
                            
                            <div style="margin-bottom: 25px;">
                                <h4 style="color: #10b981; margin-bottom: 10px;">3Ô∏è‚É£ The "3" - Outside Bar (Expansion)</h4>
                                <p style="color: #333; line-height: 1.6; margin-bottom: 10px;">
                                    An <strong>outside bar</strong> breaks BOTH the high AND low of the previous candle. This shows increased volatility and expansion.
                                </p>
                                <div style="background: #f0f0f0; padding: 12px; border-radius: 8px; font-family: monospace;">
                                    Previous Candle: High $100 | Low $95<br>
                                    Outside Bar "3": <strong style="color: #10b981;">High $102</strong> | <strong style="color: #ef4444;">Low $93</strong><br>
                                    ‚úÖ Breaks both levels = Outside bar!
                                </div>
                            </div>

                            <div style="margin-bottom: 25px;">
                                <h4 style="color: #8b5cf6; margin-bottom: 10px;">1Ô∏è‚É£ The "1" - Inside Bar (Consolidation)</h4>
                                <p style="color: #333; line-height: 1.6; margin-bottom: 10px;">
                                    An <strong>inside bar</strong> has a lower high AND higher low than the previous candle. This shows consolidation and compression.
                                </p>
                                <div style="background: #f0f0f0; padding: 12px; border-radius: 8px; font-family: monospace;">
                                    Previous Candle: High $102 | Low $93<br>
                                    Inside Bar "1": <strong style="color: #8b5cf6;">High $100</strong> | <strong style="color: #8b5cf6;">Low $96</strong><br>
                                    ‚úÖ Stays within range = Inside bar!
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 15px; border-radius: 10px; color: white;">
                                <h4 style="margin-bottom: 10px;">üéØ The 3-1 Setup</h4>
                                <p style="line-height: 1.6;">
                                    When a "1" (inside bar) follows a "3" (outside bar), you have the <strong>3-1 Strat pattern</strong>! 
                                    This signals that after a period of expansion, the price is now consolidating - like a coiled spring ready to release energy.
                                </p>
                            </div>
                        </div>

                        <!-- How to Trade It -->
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #FFA500; margin-bottom: 15px;">üí° How to Trade the 3-1 Pattern</h3>
                            
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 10px; color: white;">
                                <ul style="margin-left: 20px; line-height: 2;">
                                    <li><strong>Entry:</strong> Buy when price breaks above or below the inside bar's high or low with confirmation on the 15 min</li>
                                    <li><strong>Stop Loss:</strong> Place below the inside bar's low (or outside bar's low for wider stop)</li>
                                    <li><strong>Target:</strong> 1.5-2x the inside bar's range, or previous resistance levels</li>
                                    <li><strong>Confirmation:</strong> Higher volume on breakout adds conviction</li>
                                </ul>
                            </div>

                            <div style="background: #FFF3CD; padding: 15px; border-radius: 8px; border-left: 5px solid #f59e0b; margin-top: 20px;">
                                <p style="color: #856404; line-height: 1.6; margin: 0;">
                                    <strong>‚ö° Pro Tip:</strong> The 3-1 pattern works on ALL timeframes! 
                                    Hourly for day trades, daily for swing trades, weekly for position trades. 
                                    Higher timeframes = bigger potential moves but requires more patience.
                                </p>
                            </div>
                        </div>

                        <!-- Visual Example -->
                        <div style="background: white; padding: 20px; border-radius: 10px;">
                            <h3 style="color: #FFA500; margin-bottom: 15px;">üì∏ Visual Example</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 4em; margin-bottom: 10px;">üìä</div>
                                <p style="color: #333; font-size: 1.1em; line-height: 1.6;">
                                    <strong>Day 1:</strong> Outside Bar "3" - High $105, Low $90 (Big expansion)<br>
                                    <strong>Day 2:</strong> Inside Bar "1" - High $100, Low $95 (Consolidation)<br>
                                    <strong>Day 3:</strong> Breakout above $100 or breakdown below $95 üöÄ
                                </p>
                            </div>
                            <p style="color: #666; font-style: italic; margin-top: 15px; line-height: 1.6;">
                                üí° When you see a 3-1 pattern in Lemon Squeeze, the chart will highlight these exact levels so you can plan your trade!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Feature Guide -->
                <div class="settings-panel">
                    <h2>‚≠ê Key Features</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 15px; color: white;">
                            <h3 style="margin-bottom: 10px;">üåô Dark Mode</h3>
                            <p style="line-height: 1.6; opacity: 0.95;">
                                Toggle dark/light mode with the button in the toolbar. Your preference is saved automatically!
                            </p>
                        </div>

                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding: 20px; border-radius: 15px; color: white;">
                            <h3 style="margin-bottom: 10px;">‚≠ê Favorites System</h3>
                            <p style="line-height: 1.6; opacity: 0.95;">
                                Click the ‚≠ê on any stock to save it to favorites. Access them anytime from the Favorites button!
                            </p>
                        </div>

                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 15px; color: white;">
                            <h3 style="margin-bottom: 10px;">üìä Live Charts</h3>
                            <p style="line-height: 1.6; opacity: 0.95;">
                                Every stock gets a TradingView chart so you can see the pattern in real-time and plan your entry!
                            </p>
                        </div>

                        <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 20px; border-radius: 15px; color: white;">
                            <h3 style="margin-bottom: 10px;">üîÑ Auto-Scanners</h3>
                            <p style="line-height: 1.6; opacity: 0.95;">
                                Volemon (every 20 min) and Usuals (every 15 min) run automatically - just open the tab and watch results appear!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tips & Best Practices -->
                <div class="settings-panel">
                    <h2>üíé Tips & Best Practices</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <div style="display: grid; gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <h4 style="color: #10b981; margin-bottom: 8px;">‚úÖ DO: Confirm with Volume</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    Patterns with higher-than-average volume have better follow-through. Look for that 1.5x+ volume ratio!
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <h4 style="color: #10b981; margin-bottom: 8px;">‚úÖ DO: Wait for the Breakout</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    Don't trade inside the consolidation! Wait for price to break the inside bar's range with conviction.
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <h4 style="color: #10b981; margin-bottom: 8px;">‚úÖ DO: Use Stop Losses</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    ALWAYS use stops! Place them just outside the pattern's range. If it breaks, you're wrong - get out!
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <h4 style="color: #ef4444; margin-bottom: 8px;">‚ùå DON'T: Trade Every Setup</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    Quality > Quantity. Not every 3-1 pattern works. Look for additional confluence: trend, volume, news, sector strength.
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <h4 style="color: #ef4444; margin-bottom: 8px;">‚ùå DON'T: Ignore the Timeframe</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    Hourly patterns = quick moves (hours/days). Weekly patterns = larger moves (weeks/months). Match your trade duration to the timeframe!
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <h4 style="color: #ef4444; margin-bottom: 8px;">‚ùå DON'T: Forget Risk Management</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    Never risk more than 1-2% of your account on a single trade. Size your position so your stop loss keeps you safe!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FAQ -->
                <div class="settings-panel">
                    <h2>‚ùì Frequently Asked Questions</h2>
                    <div style="background: #FFE97F; padding: 20px; border-radius: 10px;">
                        <div style="display: grid; gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #FFA500; margin-bottom: 8px;">Q: How often should I scan?</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    <strong>A:</strong> Daily and Weekly scans: Once per day after market close. Hourly: Every 1-2 hours during market hours. 
                                    Volemon and Usuals run automatically!
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #FFA500; margin-bottom: 8px;">Q: What's the best timeframe for beginners?</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    <strong>A:</strong> Start with Daily Plays! They give you time to think, and you don't need to watch the screen all day. 
                                    Hourly is for experienced day traders only.
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #FFA500; margin-bottom: 8px;">Q: Do these patterns guarantee profits?</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    <strong>A:</strong> NO! Nothing guarantees profits in trading. The 3-1 Strat has good odds, but patterns fail sometimes. 
                                    That's why risk management is CRUCIAL!
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #FFA500; margin-bottom: 8px;">Q: Can I use this for crypto?</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    <strong>A:</strong> Absolutely! The Crypto tab scans BTC, ETH, XRP, SOL, DOGE, and HYPE. 
                                    Crypto patterns can be very powerful due to high volatility!
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #FFA500; margin-bottom: 8px;">Q: What's the Risk Score in Short Squeeze?</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    <strong>A:</strong> It's a 0-100 score combining short interest, volume, price action, and float. 
                                    Higher = better squeeze setup. But remember: high score = high potential AND high risk!
                                </p>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #FFA500; margin-bottom: 8px;">Q: Why isn't my favorite stock showing up?</h4>
                                <p style="color: #333; line-height: 1.6;">
                                    <strong>A:</strong> Either it doesn't have a 3-1 pattern right now, or it's not in the stock list. 
                                    Add it to "The Usuals" by customizing the ticker list (coming soon)!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Final Disclaimer -->
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è FINAL REMINDER - READ THIS!</strong><br><br>
                    Lemon Squeeze is a TOOL, not a crystal ball. Trading and investing carry substantial risk of loss. 
                    The 3-1 Strat pattern is an educational concept - past performance doesn't guarantee future results. 
                    Markets can be irrational, manipulated, or just plain unpredictable.<br><br>
                    <strong>YOU are responsible for your trades. Always:</strong><br>
                    ‚úÖ Do your own research (DYOR)<br>
                    ‚úÖ Never invest money you can't afford to lose<br>
                    ‚úÖ Use stop losses religiously<br>
                    ‚úÖ Start small and learn before going big<br>
                    ‚úÖ Consider consulting a licensed financial advisor<br><br>
                    This is NOT financial advice. This is NOT investment advice. 
                    This is a pattern scanning tool for educational purposes. Trade at your own risk! üçã
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Actions (Mobile Only) -->
    <div class="floating-actions">
        <!-- Auth Button for Mobile -->
        <button class="auth-button" id="authButtonMobile" onclick="openAuthModal()" style="display: flex; border-radius: 50%; width: 56px; height: 56px; padding: 0; font-size: 1.4em; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.5);">
            <span style="margin: 0;">üë§</span>
        </button>
        
        <!-- Profile Button for Mobile -->
        <button class="profile-button" id="profileButtonMobile" onclick="toggleProfileDropdown()" style="display: none; border-radius: 50%; width: 56px; height: 56px; padding: 0; position: relative;">
            <div class="profile-avatar" id="profileAvatarMobile" style="width: 100%; height: 100%; font-size: 1.5em;">U</div>
        </button>
        
        <button class="favorites-toggle" onclick="toggleFavoritesModal()">
            <span>‚≠ê</span>
            <span>Favorites</span>
            <span class="favorites-count" id="favoritesCountMobile">0</span>
        </button>
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">
            <span id="darkModeIconMobile">üåô</span>
            <span id="darkModeTextMobile">Dark</span>
        </button>
    </div>
    
    <!-- Favorites Modal -->
    <div id="favoritesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚≠ê My Favorites</h2>
                <button class="modal-close" onclick="toggleFavoritesModal()">√ó</button>
            </div>
            <div id="favoritesList">
                <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    No favorites yet! Click the ‚≠ê button on any stock to add it.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <button class="auth-close" onclick="closeAuthModal()">√ó</button>
            
            <h2 style="text-align: center; color: #FFA500; margin-bottom: 20px;">üçã Welcome to Lemon Squeeze</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>
            
            <!-- Sign In Form -->
            <form id="signinForm" class="auth-form active" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label for="signinEmail">Email</label>
                    <input type="email" id="signinEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="signinPassword">Password</label>
                    <input type="password" id="signinPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="auth-submit">Sign In</button>
                <p style="text-align: center; margin-top: 15px; color: var(--text-secondary); font-size: 0.9em;">
                    Don't have an account? <a href="#" onclick="switchAuthTab('signup'); return false;" style="color: #10b981; font-weight: bold;">Sign Up</a>
                </p>
            </form>
            
            <!-- Sign Up Form -->
            <form id="signupForm" class="auth-form" onsubmit="handleSignUp(event)">
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
                </div>
                <div class="form-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
                </div>
                <button type="submit" class="auth-submit">Create Account</button>
                <p style="text-align: center; margin-top: 15px; color: var(--text-secondary); font-size: 0.9em;">
                    Already have an account? <a href="#" onclick="switchAuthTab('signin'); return false;" style="color: #10b981; font-weight: bold;">Sign In</a>
                </p>
            </form>
        </div>
    </div>

    <!-- My Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üë§ My Profile</h2>
                <button class="modal-close" onclick="toggleProfileModal()">√ó</button>
            </div>
            <div id="profileContent" style="padding: 20px;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #FFA500, #10b981); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 3em;">
                        üë§
                    </div>
                    <h3 id="profileName" style="margin: 0 0 5px 0;"></h3>
                    <p id="profileEmail" style="color: var(--text-secondary); margin: 0;"></p>
                </div>

                <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0;">üìä Account Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Member Since</div>
                            <div id="profileMemberSince" style="font-weight: 600; font-size: 1.1em;"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Favorites</div>
                            <div id="profileFavCount" style="font-weight: 600; font-size: 1.1em;">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Journal Entries</div>
                            <div id="profileJournalCount" style="font-weight: 600; font-size: 1.1em;">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Total Scans</div>
                            <div id="profileScanCount" style="font-weight: 600; font-size: 1.1em;">0</div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="toggleProfileModal()" style="flex: 1; padding: 12px; background: var(--text-secondary); color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="toggleSettingsModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <!-- Theme Setting -->
                <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0;">üé® Appearance</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">Dark Mode</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Toggle between light and dark theme</div>
                        </div>
                        <button id="darkModeToggle" onclick="toggleTheme()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Toggle
                        </button>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0;">üîî Notifications</h4>
                    <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span>Scan completion alerts</span>
                        <input type="checkbox" id="notifyScanComplete" checked style="width: 20px; height: 20px;">
                    </label>
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <span>High-risk squeeze notifications</span>
                        <input type="checkbox" id="notifyHighRisk" checked style="width: 20px; height: 20px;">
                    </label>
                </div>

                <!-- Scan Preferences -->
                <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0;">üìä Scan Preferences</h4>
                    <label style="display: block; margin-bottom: 10px;">
                        <span style="display: block; margin-bottom: 5px;">Auto-save scan results</span>
                        <input type="checkbox" id="autoSaveScan" checked style="width: 20px; height: 20px;">
                    </label>
                    <label style="display: block;">
                        <span style="display: block; margin-bottom: 5px;">Show debug logs</span>
                        <input type="checkbox" id="showDebugLogs" style="width: 20px; height: 20px;">
                    </label>
                </div>

                <!-- Danger Zone -->
                <div style="background: #fef2f2; border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #ef4444;">‚ö†Ô∏è Danger Zone</h4>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #dc2626;">Delete Account</div>
                        <div style="font-size: 0.9em; color: #991b1b; margin-top: 5px;">
                            Permanently delete your account, favorites, journal entries, and all data. This action cannot be undone.
                        </div>
                    </div>
                    <button onclick="deleteAccount()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Delete My Account
                    </button>
                </div>

                <button onclick="saveSettings()" style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Trading Journal Modal -->
    <div id="journalModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìä Trading Journal</h2>
                <button class="modal-close" onclick="toggleJournalModal()">√ó</button>
            </div>
            <div style="padding: 20px;">
                <!-- Add Entry Button -->
                <button onclick="showAddJournalEntry()" style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 20px;">
                    ‚ûï Add Journal Entry
                </button>

                <!-- Journal Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">üìù</div>
                        <div style="font-size: 1.5em; font-weight: 600;" id="journalTotalEntries">0</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">Total Entries</div>
                    </div>
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">‚úÖ</div>
                        <div style="font-size: 1.5em; font-weight: 600; color: #10b981;" id="journalWins">0</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">Wins</div>
                    </div>
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">‚ùå</div>
                        <div style="font-size: 1.5em; font-weight: 600; color: #ef4444;" id="journalLosses">0</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">Losses</div>
                    </div>
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">üìà</div>
                        <div style="font-size: 1.5em; font-weight: 600;" id="journalWinRate">0%</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">Win Rate</div>
                    </div>
                </div>

                <!-- Journal Entries List -->
                <div id="journalEntriesList" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        No journal entries yet. Click "Add Journal Entry" to start tracking your trades!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Journal Entry Modal -->
    <div id="addJournalModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚ûï Add Journal Entry</h2>
                <button class="modal-close" onclick="hideAddJournalEntry()">√ó</button>
            </div>
            <form id="journalEntryForm" onsubmit="saveJournalEntry(event)" style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Stock Ticker</label>
                    <input type="text" id="journalTicker" required placeholder="e.g. AAPL" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Entry Date</label>
                        <input type="date" id="journalDate" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Trade Type</label>
                        <select id="journalType" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Entry Price</label>
                        <input type="number" id="journalEntryPrice" required step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Exit Price (optional)</label>
                        <input type="number" id="journalExitPrice" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Position Size</label>
                    <input type="number" id="journalPositionSize" required placeholder="Number of shares" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Outcome</label>
                    <select id="journalOutcome" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <option value="pending">Pending</option>
                        <option value="win">Win ‚úÖ</option>
                        <option value="loss">Loss ‚ùå</option>
                        <option value="breakeven">Break Even</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes</label>
                    <textarea id="journalNotes" rows="4" placeholder="Trade setup, patterns observed, lessons learned..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit;"></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="hideAddJournalEntry()" style="flex: 1; padding: 12px; background: var(--text-secondary); color: white; border: none; border-radius: 8px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Save Entry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Global Chat (Only for logged-in users) -->
    <div id="chatButton" class="chat-button" onclick="toggleChat()" style="display: none;">
        üí¨
        <span class="chat-notification" id="chatNotification" style="display: none;">!</span>
    </div>

    <!-- Chat Panel -->
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <div>
                <h3 style="margin: 0;">üí¨ Community Chat</h3>
                <p style="margin: 0; font-size: 0.8em; opacity: 0.8;">Live chat with traders</p>
            </div>
            <button class="chat-close" onclick="toggleChat()">√ó</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p>üëã Welcome to the community chat!</p>
                <p style="font-size: 0.9em;">Share ideas, discuss trades, and connect with other traders.</p>
            </div>
        </div>

        <form class="chat-input-form" onsubmit="sendMessage(event)">
            <input
                type="text"
                id="chatInput"
                placeholder="Type a message..."
                maxlength="500"
                required
                autocomplete="off"
            />
            <button type="submit">Send</button>
        </form>
    </div>

    <style>
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            transition: all 0.3s;
            z-index: 999;
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
        }

        .chat-notification {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .chat-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 380px;
            height: 550px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            transform: translateY(calc(100% + 40px));
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow: hidden;
        }

        .chat-panel.active {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .chat-message.own {
            align-items: flex-end;
        }

        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .chat-message.own .chat-message-header {
            flex-direction: row-reverse;
        }

        .chat-message-avatar {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #FFA500, #10b981);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: white;
            font-weight: bold;
        }

        .chat-message-bubble {
            background: var(--bg);
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 75%;
            word-wrap: break-word;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chat-message.own .chat-message-bubble {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .chat-message-time {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .chat-input-form {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .chat-input-form input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 24px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95em;
            outline: none;
        }

        .chat-input-form input:focus {
            border-color: #10b981;
        }

        .chat-input-form button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-input-form button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        @media (max-width: 480px) {
            .chat-panel {
                width: calc(100vw - 40px);
                height: calc(100vh - 80px);
                bottom: 20px;
                right: 20px;
            }

            .chat-button {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        let isScanning = false;
        
        // ===== AUTHENTICATION SYSTEM =====
        let currentUser = null;
        
        // Load user session on page load
        async function loadUserSession() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    updateAuthUI();
                    // Load user's favorites from server
                    loadFavoritesFromServer();
                }
            } catch (error) {
                console.log('No active session');
            }
        }
        
        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }
        
        function switchAuthTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update forms
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            
            if (tab === 'signin') {
                document.getElementById('signinForm').classList.add('active');
            } else {
                document.getElementById('signupForm').classList.add('active');
            }
        }
        
        async function handleSignIn(event) {
            event.preventDefault();
            
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            
            try {
                const response = await fetch('/api/auth/signin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    updateAuthUI();
                    closeAuthModal();
                    
                    // Clear form
                    document.getElementById('signinForm').reset();
                    
                    // Load favorites from server
                    loadFavoritesFromServer();
                    
                    // Welcome message
                    alert(`üçã Welcome back, ${currentUser.name}!`);
                } else {
                    alert(`‚ùå ${data.error}`);
                }
            } catch (error) {
                alert('‚ùå Error signing in. Please try again.');
                console.error('Sign in error:', error);
            }
        }
        
        async function handleSignUp(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            
            // Validate
            if (password !== confirmPassword) {
                alert('‚ùå Passwords do not match!');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    updateAuthUI();
                    closeAuthModal();
                    
                    // Clear form
                    document.getElementById('signupForm').reset();
                    
                    // Welcome message
                    alert(`üéâ Welcome to Lemon Squeeze, ${currentUser.name}! Your account has been created.`);
                } else {
                    alert(`‚ùå ${data.error}`);
                }
            } catch (error) {
                alert('‚ùå Error creating account. Please try again.');
                console.error('Sign up error:', error);
            }
        }
        
        function updateAuthUI() {
            const authButton = document.getElementById('authButton');
            const profileButton = document.getElementById('profileButton');
            const authButtonMobile = document.getElementById('authButtonMobile');
            const profileButtonMobile = document.getElementById('profileButtonMobile');
            const chatButton = document.getElementById('chatButton');

            if (currentUser) {
                // Show profile button, hide auth button (both desktop and mobile)
                authButton.style.display = 'none';
                profileButton.style.display = 'flex';
                authButtonMobile.style.display = 'none';
                profileButtonMobile.style.display = 'flex';

                // Show chat button (only for logged-in users)
                chatButton.style.display = 'flex';

                // Update profile info (both desktop and mobile)
                document.getElementById('profileAvatar').textContent = currentUser.avatar;
                document.getElementById('profileAvatarMobile').textContent = currentUser.avatar;
                document.getElementById('profileName').textContent = currentUser.name.split(' ')[0]; // First name only
                document.getElementById('dropdownName').textContent = currentUser.name;
                document.getElementById('dropdownEmail').textContent = currentUser.email;

                // Load chat messages when user signs in
                loadChatMessages();
                startChatPolling();
            } else {
                // Show auth button, hide profile button (both desktop and mobile)
                authButton.style.display = 'flex';
                profileButton.style.display = 'none';
                authButtonMobile.style.display = 'flex';
                profileButtonMobile.style.display = 'none';

                // Hide chat button (only for guests)
                chatButton.style.display = 'none';

                // Stop chat polling
                stopChatPolling();
            }
        }
        
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const authContainer = document.querySelector('.auth-container');
            const dropdown = document.getElementById('profileDropdown');
            
            if (authContainer && !authContainer.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        function viewProfile() {
            toggleProfileDropdown();
            if (!currentUser) {
                alert('Please sign in to view your profile');
                return;
            }

            // Populate profile data
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;

            const memberSince = new Date(currentUser.created_at || Date.now()).toLocaleDateString();
            document.getElementById('profileMemberSince').textContent = memberSince;

            // Load favorites count
            loadFavoritesFromServer().then(() => {
                const favCount = document.querySelectorAll('#favoritesList .favorite-item').length;
                document.getElementById('profileFavCount').textContent = favCount;
            });

            // Load journal count
            loadJournalEntries().then(entries => {
                document.getElementById('profileJournalCount').textContent = entries.length;
            });

            // Scan count (from localStorage)
            const scanCount = localStorage.getItem('totalScans') || 0;
            document.getElementById('profileScanCount').textContent = scanCount;

            toggleProfileModal();
        }

        function toggleProfileModal() {
            document.getElementById('profileModal').classList.toggle('active');
        }

        function viewSettings() {
            toggleProfileDropdown();

            // Load current settings from localStorage
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            document.getElementById('notifyScanComplete').checked = settings.notifyScanComplete !== false;
            document.getElementById('notifyHighRisk').checked = settings.notifyHighRisk !== false;
            document.getElementById('autoSaveScan').checked = settings.autoSaveScan !== false;
            document.getElementById('showDebugLogs').checked = settings.showDebugLogs || false;

            toggleSettingsModal();
        }

        function toggleSettingsModal() {
            document.getElementById('settingsModal').classList.toggle('active');
        }

        function saveSettings() {
            const settings = {
                notifyScanComplete: document.getElementById('notifyScanComplete').checked,
                notifyHighRisk: document.getElementById('notifyHighRisk').checked,
                autoSaveScan: document.getElementById('autoSaveScan').checked,
                showDebugLogs: document.getElementById('showDebugLogs').checked
            };

            localStorage.setItem('userSettings', JSON.stringify(settings));
            alert('‚úÖ Settings saved successfully!');
        }

        async function deleteAccount() {
            if (!currentUser) {
                alert('You must be signed in to delete your account');
                return;
            }

            const confirmation = prompt('‚ö†Ô∏è WARNING: This will permanently delete your account and all data!\n\nType "DELETE" to confirm:');

            if (confirmation !== 'DELETE') {
                alert('Account deletion cancelled');
                return;
            }

            try {
                const response = await fetch('/api/auth/delete', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Your account has been permanently deleted');

                    // Sign out and reset UI
                    currentUser = null;
                    updateAuthUI();
                    toggleSettingsModal();
                    localStorage.clear();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('‚ùå Failed to delete account');
            }
        }

        async function viewHistory() {
            toggleProfileDropdown();
            if (!currentUser) {
                alert('Please sign in to access your trading journal');
                return;
            }

            // Load and display journal
            await loadJournalEntries();
            toggleJournalModal();
        }

        function toggleJournalModal() {
            document.getElementById('journalModal').classList.toggle('active');
        }

        function showAddJournalEntry() {
            // Set today's date as default
            document.getElementById('journalDate').valueAsDate = new Date();
            document.getElementById('addJournalModal').classList.add('active');
        }

        function hideAddJournalEntry() {
            document.getElementById('addJournalModal').classList.remove('active');
            document.getElementById('journalEntryForm').reset();
        }

        async function saveJournalEntry(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('Please sign in to save journal entries');
                return;
            }

            const entry = {
                ticker: document.getElementById('journalTicker').value.toUpperCase(),
                date: document.getElementById('journalDate').value,
                type: document.getElementById('journalType').value,
                entryPrice: parseFloat(document.getElementById('journalEntryPrice').value),
                exitPrice: document.getElementById('journalExitPrice').value ? parseFloat(document.getElementById('journalExitPrice').value) : null,
                positionSize: parseInt(document.getElementById('journalPositionSize').value),
                outcome: document.getElementById('journalOutcome').value,
                notes: document.getElementById('journalNotes').value,
                createdAt: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/journal/entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Journal entry saved!');
                    hideAddJournalEntry();
                    loadJournalEntries(); // Reload the list
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving journal entry:', error);
                alert('‚ùå Failed to save journal entry');
            }
        }

        async function loadJournalEntries() {
            if (!currentUser) return [];

            try {
                const response = await fetch('/api/journal/entries');
                const data = await response.json();

                if (data.success) {
                    displayJournalEntries(data.entries);
                    return data.entries;
                }
            } catch (error) {
                console.error('Error loading journal entries:', error);
            }

            return [];
        }

        function displayJournalEntries(entries) {
            const listEl = document.getElementById('journalEntriesList');

            if (!entries || entries.length === 0) {
                listEl.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    No journal entries yet. Click "Add Journal Entry" to start tracking your trades!
                </p>`;

                document.getElementById('journalTotalEntries').textContent = '0';
                document.getElementById('journalWins').textContent = '0';
                document.getElementById('journalLosses').textContent = '0';
                document.getElementById('journalWinRate').textContent = '0%';
                return;
            }

            // Calculate stats
            const wins = entries.filter(e => e.outcome === 'win').length;
            const losses = entries.filter(e => e.outcome === 'loss').length;
            const winRate = wins + losses > 0 ? ((wins / (wins + losses)) * 100).toFixed(1) : 0;

            document.getElementById('journalTotalEntries').textContent = entries.length;
            document.getElementById('journalWins').textContent = wins;
            document.getElementById('journalLosses').textContent = losses;
            document.getElementById('journalWinRate').textContent = winRate + '%';

            // Display entries
            listEl.innerHTML = entries.map(entry => {
                const pl = entry.exitPrice && entry.entryPrice ?
                    ((entry.exitPrice - entry.entryPrice) * entry.positionSize).toFixed(2) : 'N/A';

                const outcomeIcons = {
                    'win': '‚úÖ',
                    'loss': '‚ùå',
                    'breakeven': '‚ûñ',
                    'pending': '‚è≥'
                };

                return `
                    <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; position: relative;">
                        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 8px;">
                            <button onclick="editJournalEntry('${entry.id}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">‚úèÔ∏è Edit</button>
                            <button onclick="deleteJournalEntry('${entry.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">üóëÔ∏è Delete</button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; padding-right: 180px;">
                            <div>
                                <h3 style="margin: 0 0 5px 0;">${entry.ticker} ${outcomeIcons[entry.outcome]}</h3>
                                <div style="color: var(--text-secondary); font-size: 0.9em;">${new Date(entry.date).toLocaleDateString()} ‚Ä¢ ${entry.type.toUpperCase()}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 1.2em; color: ${pl !== 'N/A' && parseFloat(pl) > 0 ? '#10b981' : pl !== 'N/A' && parseFloat(pl) < 0 ? '#ef4444' : 'var(--text)'};">
                                    ${pl !== 'N/A' ? '$' + pl : 'Pending'}
                                </div>
                                <div style="font-size: 0.9em; color: var(--text-secondary);">P/L</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; font-size: 0.9em;">
                            <div>
                                <div style="color: var(--text-secondary);">Entry</div>
                                <div style="font-weight: 600;">$${entry.entryPrice.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary);">Exit</div>
                                <div style="font-weight: 600;">${entry.exitPrice ? '$' + entry.exitPrice.toFixed(2) : 'Open'}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-secondary);">Size</div>
                                <div style="font-weight: 600;">${entry.positionSize} shares</div>
                            </div>
                        </div>
                        ${entry.notes ? `<div style="padding: 10px; background: var(--bg); border-radius: 8px; font-size: 0.9em; color: var(--text-secondary);">
                            üìù ${entry.notes}
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function editJournalEntry(entryId) {
            if (!currentUser) return;

            try {
                // Get the entry
                const response = await fetch('/api/journal/entries');
                const data = await response.json();

                if (data.success) {
                    const entry = data.entries.find(e => e.id === entryId);
                    if (!entry) {
                        alert('Entry not found');
                        return;
                    }

                    // Populate the form
                    document.getElementById('journalTicker').value = entry.ticker;
                    document.getElementById('journalDate').value = entry.date;
                    document.getElementById('journalType').value = entry.type;
                    document.getElementById('journalEntryPrice').value = entry.entryPrice;
                    document.getElementById('journalExitPrice').value = entry.exitPrice || '';
                    document.getElementById('journalPositionSize').value = entry.positionSize;
                    document.getElementById('journalOutcome').value = entry.outcome;
                    document.getElementById('journalNotes').value = entry.notes || '';

                    // Change form submit to update instead of create
                    const form = document.getElementById('journalEntryForm');
                    form.onsubmit = async (event) => {
                        event.preventDefault();

                        const updatedEntry = {
                            exitPrice: document.getElementById('journalExitPrice').value ? parseFloat(document.getElementById('journalExitPrice').value) : null,
                            outcome: document.getElementById('journalOutcome').value,
                            notes: document.getElementById('journalNotes').value
                        };

                        try {
                            const response = await fetch(`/api/journal/entry/${entryId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatedEntry)
                            });

                            const data = await response.json();

                            if (data.success) {
                                alert('‚úÖ Journal entry updated!');
                                hideAddJournalEntry();
                                loadJournalEntries();

                                // Reset form back to create mode
                                form.onsubmit = saveJournalEntry;
                            } else {
                                alert('‚ùå Error: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error updating journal entry:', error);
                            alert('‚ùå Failed to update journal entry');
                        }
                    };

                    // Show the modal
                    document.getElementById('addJournalModal').classList.add('active');

                    // Update modal title
                    document.querySelector('#addJournalModal .modal-header h2').textContent = '‚úèÔ∏è Edit Journal Entry';
                }
            } catch (error) {
                console.error('Error loading journal entry:', error);
                alert('‚ùå Failed to load journal entry');
            }
        }

        async function deleteJournalEntry(entryId) {
            if (!confirm('Are you sure you want to delete this journal entry? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/journal/entry/${entryId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Journal entry deleted');
                    loadJournalEntries();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting journal entry:', error);
                alert('‚ùå Failed to delete journal entry');
            }
        }

        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await fetch('/api/auth/signout', { method: 'POST' });
                    
                    currentUser = null;
                    updateAuthUI();
                    toggleProfileDropdown();
                    
                    // Clear any local data
                    localStorage.removeItem('lemonFavorites');
                    
                    alert('üëã You have been signed out successfully!');
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            }
        }
        
        // Load favorites from server
        async function loadFavoritesFromServer() {
            if (!currentUser) return;
            
            try {
                const response = await fetch('/api/favorites');
                const data = await response.json();
                
                if (data.success) {
                    // Sync with localStorage format for existing code compatibility
                    const favorites = data.favorites.map(fav => ({
                        ticker: fav.ticker,
                        company: fav.company,
                        timeframe: fav.timeframe,
                        addedAt: fav.added_at
                    }));
                    
                    localStorage.setItem('lemonFavorites', JSON.stringify(favorites));
                    updateFavoritesCount();
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }
        
        // ===== DARK MODE =====
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update both desktop and mobile buttons
            const icons = [document.getElementById('darkModeIcon'), document.getElementById('darkModeIconMobile')];
            const texts = [document.getElementById('darkModeText'), document.getElementById('darkModeTextMobile')];
            
            icons.forEach(icon => {
                if (icon) {
                    icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                }
            });
            
            texts.forEach(text => {
                if (text) {
                    text.textContent = newTheme === 'dark' ? 'Light' : 'Dark';
                }
            });
        }
        
        // ===== MARKET TIMER =====
        function updateMarketTimer() {
            const now = new Date();

            // Convert to ET (UTC-5 or UTC-4 for DST)
            const etOffset = -5; // Standard time offset
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const etTime = new Date(utc + (3600000 * etOffset));

            const day = etTime.getDay(); // 0 = Sunday, 6 = Saturday
            const hours = etTime.getHours();
            const minutes = etTime.getMinutes();
            const seconds = etTime.getSeconds();

            const timerElement = document.getElementById('marketTimer');
            const timeElement = document.getElementById('marketTimerTime');
            const labelElement = document.getElementById('marketTimerLabel');

            // Weekend check
            if (day === 0 || day === 6) {
                // Weekend - show time until Monday 9:30 AM
                const daysUntilMonday = day === 0 ? 1 : 2;
                const monday = new Date(etTime);
                monday.setDate(etTime.getDate() + daysUntilMonday);
                monday.setHours(9, 30, 0, 0);

                const diff = monday - etTime;
                const daysLeft = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hoursLeft = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minsLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                timerElement.className = 'market-timer market-closed';
                timeElement.textContent = `${daysLeft}d ${hoursLeft}h ${minsLeft}m`;
                labelElement.textContent = 'until open';
                return;
            }

            // Market hours: 9:30 AM - 4:00 PM ET
            const marketOpenMinutes = (9 * 60) + 30;  // 9:30 AM
            const marketCloseMinutes = 16 * 60;        // 4:00 PM
            const currentMinutes = (hours * 60) + minutes;

            if (currentMinutes >= marketOpenMinutes && currentMinutes < marketCloseMinutes) {
                // Market is OPEN - show time until close
                const closeTime = new Date(etTime);
                closeTime.setHours(16, 0, 0, 0);

                const diff = closeTime - etTime;
                const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
                const minsLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secsLeft = Math.floor((diff % (1000 * 60)) / 1000);

                timerElement.className = 'market-timer market-open';
                timeElement.textContent = `${hoursLeft}:${String(minsLeft).padStart(2, '0')}:${String(secsLeft).padStart(2, '0')}`;
                labelElement.textContent = 'until close';
            } else {
                // Market is CLOSED - show time until next open
                const openTime = new Date(etTime);

                if (currentMinutes >= marketCloseMinutes) {
                    // After close - next open is tomorrow (or Monday)
                    const daysToAdd = (day === 5) ? 3 : 1; // Friday -> Monday, else next day
                    openTime.setDate(etTime.getDate() + daysToAdd);
                }

                openTime.setHours(9, 30, 0, 0);

                const diff = openTime - etTime;
                const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
                const minsLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secsLeft = Math.floor((diff % (1000 * 60)) / 1000);

                timerElement.className = 'market-timer market-closed';
                timeElement.textContent = `${hoursLeft}:${String(minsLeft).padStart(2, '0')}:${String(secsLeft).padStart(2, '0')}`;
                labelElement.textContent = 'until open';
            }
        }

        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load authentication
            loadUserSession();

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            if (savedTheme === 'dark') {
                const icons = [document.getElementById('darkModeIcon'), document.getElementById('darkModeIconMobile')];
                const texts = [document.getElementById('darkModeText'), document.getElementById('darkModeTextMobile')];

                icons.forEach(icon => {
                    if (icon) icon.textContent = '‚òÄÔ∏è';
                });

                texts.forEach(text => {
                    if (text) text.textContent = 'Light';
                });
            }

            updateFavoritesCount();
            loadHistoricalData();

            // Start market timer
            updateMarketTimer();
            setInterval(updateMarketTimer, 1000); // Update every second
        });
        
        // ===== FAVORITES SYSTEM =====
        function getFavorites() {
            const favorites = localStorage.getItem('lemonFavorites');
            return favorites ? JSON.parse(favorites) : [];
        }
        
        function saveFavorites(favorites) {
            localStorage.setItem('lemonFavorites', JSON.stringify(favorites));
            updateFavoritesCount();
        }
        
        async function addToFavorites(ticker, company, timeframe = 'daily') {
            const favorites = getFavorites();
            const exists = favorites.find(f => f.ticker === ticker && f.timeframe === timeframe);
            
            if (!exists) {
                // Add to local storage first
                favorites.push({
                    ticker,
                    company,
                    timeframe,
                    addedAt: new Date().toISOString()
                });
                saveFavorites(favorites);
                
                // If user is logged in, save to server
                if (currentUser) {
                    try {
                        await fetch('/api/favorites', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ ticker, company, timeframe })
                        });
                    } catch (error) {
                        console.error('Error saving favorite to server:', error);
                    }
                }
                
                alert(`‚úÖ ${ticker} added to favorites!`);
            } else {
                alert(`‚ÑπÔ∏è ${ticker} is already in favorites`);
            }
        }
        
        async function removeFromFavorites(ticker, timeframe) {
            let favorites = getFavorites();
            favorites = favorites.filter(f => !(f.ticker === ticker && f.timeframe === timeframe));
            saveFavorites(favorites);
            displayFavorites();
            
            // If user is logged in, remove from server
            if (currentUser) {
                try {
                    await fetch(`/api/favorites/${ticker}/${timeframe}`, {
                        method: 'DELETE'
                    });
                } catch (error) {
                    console.error('Error removing favorite from server:', error);
                }
            }
        }
        
        function updateFavoritesCount() {
            const count = getFavorites().length;
            // Update both desktop and mobile counters
            const desktopCounter = document.getElementById('favoritesCount');
            const mobileCounter = document.getElementById('favoritesCountMobile');
            
            if (desktopCounter) desktopCounter.textContent = count;
            if (mobileCounter) mobileCounter.textContent = count;
        }
        
        function toggleFavoritesModal() {
            const modal = document.getElementById('favoritesModal');
            const isActive = modal.classList.contains('active');
            
            if (isActive) {
                modal.classList.remove('active');
            } else {
                modal.classList.add('active');
                displayFavorites();
            }
        }
        
        function displayFavorites() {
            const favorites = getFavorites();
            const container = document.getElementById('favoritesList');
            
            if (favorites.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        No favorites yet! Click the ‚≠ê button on any stock to add it.
                    </p>
                `;
                return;
            }
            
            let html = '';
            favorites.forEach(fav => {
                const winRate = getWinRate(fav.ticker, fav.timeframe);
                html += `
                    <div class="favorite-item">
                        <div class="favorite-info">
                            <div class="favorite-ticker">
                                ${fav.ticker}
                                ${winRate.badge}
                            </div>
                            <div class="favorite-meta">
                                ${fav.company} ‚Ä¢ ${fav.timeframe} ‚Ä¢ Added ${new Date(fav.addedAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="favorite-actions">
                            <button class="favorite-scan-btn" onclick="scanFavorite('${fav.ticker}', '${fav.timeframe}')">
                                üîç Scan
                            </button>
                            <button class="favorite-remove-btn" onclick="removeFromFavorites('${fav.ticker}', '${fav.timeframe}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function scanFavorite(ticker, timeframe) {
            // Close modal and switch to appropriate tab
            toggleFavoritesModal();
            
            // Switch to the right tab
            if (timeframe === 'hourly') {
                switchTab('hourly');
                startHourlyScan();
            } else if (timeframe === 'daily') {
                switchTab('daily');
                startDailyScan();
            } else if (timeframe === 'weekly') {
                switchTab('weekly');
                startWeeklyScan();
            } else if (timeframe === 'crypto') {
                switchTab('crypto');
                startCryptoScan();
            }
        }
        
        // ===== HISTORICAL WIN RATE TRACKING =====
        function getHistoricalData() {
            const data = localStorage.getItem('lemonHistorical');
            return data ? JSON.parse(data) : [];
        }
        
        function saveHistoricalData(data) {
            localStorage.setItem('lemonHistorical', JSON.stringify(data));
        }
        
        function trackPattern(ticker, timeframe, direction, currentPrice, patternDate) {
            const historical = getHistoricalData();
            
            historical.push({
                ticker,
                timeframe,
                direction,
                entryPrice: currentPrice,
                patternDate: patternDate,
                recordedAt: new Date().toISOString(),
                outcome: 'pending'
            });
            
            saveHistoricalData(historical);
        }
        
        async function loadHistoricalData() {
            // Check patterns after 7 days to see if they were successful
            const historical = getHistoricalData();
            const now = new Date();
            
            for (let pattern of historical) {
                if (pattern.outcome === 'pending') {
                    const recordedDate = new Date(pattern.recordedAt);
                    const daysSince = (now - recordedDate) / (1000 * 60 * 60 * 24);
                    
                    // Check after 7 days
                    if (daysSince >= 7) {
                        try {
                            const ticker = pattern.ticker.includes('-') ? pattern.ticker : pattern.ticker;
                            const stock = yf.Ticker(ticker);
                            const hist = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1mo`);
                            const data = await hist.json();
                            
                            if (data && data.chart && data.chart.result[0]) {
                                const prices = data.chart.result[0].indicators.quote[0].close;
                                const currentPrice = prices[prices.length - 1];
                                const priceChange = ((currentPrice - pattern.entryPrice) / pattern.entryPrice) * 100;
                                
                                // Consider it a win if:
                                // - Bullish pattern and price went up 3%+
                                // - Bearish pattern and price went down 3%+
                                if (pattern.direction === 'bullish' && priceChange >= 3) {
                                    pattern.outcome = 'win';
                                    pattern.exitPrice = currentPrice;
                                    pattern.profitPercent = priceChange;
                                } else if (pattern.direction === 'bearish' && priceChange <= -3) {
                                    pattern.outcome = 'win';
                                    pattern.exitPrice = currentPrice;
                                    pattern.profitPercent = Math.abs(priceChange);
                                } else if (Math.abs(priceChange) < 3) {
                                    pattern.outcome = 'neutral';
                                } else {
                                    pattern.outcome = 'loss';
                                    pattern.exitPrice = currentPrice;
                                    pattern.profitPercent = priceChange;
                                }
                            }
                        } catch (e) {
                            console.error(`Error checking ${pattern.ticker}:`, e);
                        }
                    }
                }
            }
            
            saveHistoricalData(historical);
        }
        
        function getWinRate(ticker, timeframe) {
            const historical = getHistoricalData();
            const patterns = historical.filter(p => 
                p.ticker === ticker && 
                p.timeframe === timeframe &&
                p.outcome !== 'pending'
            );
            
            if (patterns.length === 0) {
                return {
                    rate: null,
                    badge: '<span class="win-rate-badge win-rate-new">NEW</span>'
                };
            }
            
            const wins = patterns.filter(p => p.outcome === 'win').length;
            const rate = (wins / patterns.length * 100).toFixed(0);
            
            let badgeClass = 'win-rate-medium';
            if (rate >= 70) badgeClass = 'win-rate-high';
            else if (rate < 50) badgeClass = 'win-rate-low';
            
            return {
                rate: rate,
                badge: `<span class="win-rate-badge ${badgeClass}">${rate}% Win (${wins}/${patterns.length})</span>`
            };
        }
        
        // ===== CHART INTEGRATION =====
        function createChart(containerId, ticker, timeframe = 'daily') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Map timeframe to TradingView interval
            const intervalMap = {
                'hourly': '60',
                'daily': 'D',
                'weekly': 'W',
                'crypto': 'D'
            };
            
            const interval = intervalMap[timeframe] || 'D';
            const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            
            // For crypto, use the format expected by TradingView
            const symbol = ticker.includes('-USD') ? `CRYPTO:${ticker.replace('-USD', 'USD')}` : ticker;
            
            container.innerHTML = `
                <iframe 
                    src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_chart&symbol=${symbol}&interval=${interval}&hidesidetoolbar=0&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=${theme}&style=1&timezone=Etc%2FUTC&withdateranges=1&showpopupbutton=1&studies_overrides={}&overrides={}&enabled_features=[]&disabled_features=[]&showpopupbutton=1&popup_height=650&popup_width=1000&locale=en"
                    style="width: 100%; height: 100%; margin: 0; padding: 0; border: none;"
                    frameborder="0"
                    allowtransparency="true"
                    scrolling="no"
                ></iframe>
            `;
        }
        
        // Tab switching
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tab === 'squeeze') {
                document.getElementById('squeezeTab').classList.add('active');
            } else if (tab === 'hourly') {
                document.getElementById('hourlyTab').classList.add('active');
            } else if (tab === 'daily') {
                document.getElementById('dailyTab').classList.add('active');
            } else if (tab === 'weekly') {
                document.getElementById('weeklyTab').classList.add('active');
            } else if (tab === 'crypto') {
                document.getElementById('cryptoTab').classList.add('active');
            } else if (tab === 'volemon') {
                document.getElementById('volemonTab').classList.add('active');
            } else if (tab === 'usuals') {
                document.getElementById('usualsTab').classList.add('active');
            } else if (tab === 'lemonai') {
                document.getElementById('lemonaiTab').classList.add('active');
                // Auto-load LemonAI recommendations and stats when tab is opened
                loadLemonAIStats(); // Always load stats first
                if (document.getElementById('lemonaiResults').innerHTML === '') {
                    startLemonAIScan();
                }
                // Start auto-refresh for real-time updates
                startLemonAIAutoRefresh();
            } else if (tab === 'challenges') {
                document.getElementById('challengesTab').classList.add('active');
                // Auto-load challenges when tab is opened
                loadChallenges();
            } else if (tab === 'lemonade') {
                document.getElementById('lemonadeTab').classList.add('active');
                // Auto-load dividend data when tab is opened
                loadDividendData();
            } else if (tab === 'howto') {
                document.getElementById('howtoTab').classList.add('active');
            }

            // Stop auto-refresh when switching away from LemonAI tab
            if (tab !== 'lemonai') {
                stopLemonAIAutoRefresh();
            }
        }

        // Auto-refresh system for LemonAI (checks for new plays every 5 minutes during market hours)
        let autoRefreshInterval = null;
        let lastRecommendationCount = 0;

        function startLemonAIAutoRefresh() {
            // Clear any existing interval
            stopLemonAIAutoRefresh();

            console.log("üîÑ Starting LemonAI auto-refresh (checks every 5 minutes)");

            // Check immediately
            checkForNewRecommendations();

            // Then check every 5 minutes
            autoRefreshInterval = setInterval(() => {
                checkForNewRecommendations();
            }, 300000); // 5 minutes
        }

        function stopLemonAIAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log("‚è∏Ô∏è  LemonAI auto-refresh stopped");
            }
        }

        async function checkForNewRecommendations() {
            try {
                // Only check if LemonAI tab is active
                if (!document.getElementById('lemonaiTab').classList.contains('active')) {
                    return;
                }

                console.log("üîç Checking for new recommendations...");

                const response = await fetch('/api/lemonai-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success && data.recommendations) {
                    const newCount = data.recommendations.length;

                    // If count changed or this is first check, update display
                    if (lastRecommendationCount === 0 || newCount !== lastRecommendationCount) {
                        console.log(`üìä Found ${newCount} recommendations (was ${lastRecommendationCount})`);

                        // Show notification if new plays appeared
                        if (lastRecommendationCount > 0 && newCount > lastRecommendationCount) {
                            showNewPlaysNotification(newCount - lastRecommendationCount);
                        }

                        lastRecommendationCount = newCount;
                        displayLemonAIResults(data.recommendations, data.cached, data.cache_age_minutes);
                        loadLemonAIStats(); // Also refresh stats
                    } else {
                        console.log("‚úì No new recommendations");
                    }
                }
            } catch (error) {
                console.error("Error checking for new recommendations:", error);
            }
        }

        function showNewPlaysNotification(newPlaysCount) {
            // Show a subtle notification at the top
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = `üî• ${newPlaysCount} NEW PLAY${newPlaysCount > 1 ? 'S' : ''} DETECTED!`;

            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }

        // Short Squeeze Scanner
        async function startSqueezeScan() {
            if (isScanning) return;
            
            const minShort = parseFloat(document.getElementById('minShort').value);
            const minGain = parseFloat(document.getElementById('minGain').value);
            const minVolRatio = parseFloat(document.getElementById('minVolRatio').value);
            const minRisk = parseFloat(document.getElementById('minRisk').value);
            
            if (isNaN(minShort) || isNaN(minGain) || isNaN(minVolRatio) || isNaN(minRisk)) {
                alert('Please enter valid numbers!');
                return;
            }
            
            isScanning = true;
            document.getElementById('scanButton').disabled = true;
            document.getElementById('scanButton').textContent = '‚è≥ SCANNING...';
            document.getElementById('squeezeLoading').classList.add('active');
            document.getElementById('squeezeResults').classList.remove('active');
            
            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        minShort,
                        minGain,
                        minVolRatio,
                        minRisk
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displaySqueezeResults(data.results, minShort, minGain, minVolRatio, minRisk);
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Error scanning: ' + error.message);
            } finally {
                isScanning = false;
                document.getElementById('scanButton').disabled = false;
                document.getElementById('scanButton').textContent = 'üîç SCAN FOR SQUEEZES üçã';
                document.getElementById('squeezeLoading').classList.remove('active');
            }
        }
        
        function displaySqueezeResults(candidates, minShort, minGain, minVolRatio, minRisk) {
            const resultsDiv = document.getElementById('squeezeResults');
            resultsDiv.classList.add('active');
            
            if (candidates.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h3>üçã No Squeezes Found Today</h3>
                        <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                            No stocks met the criteria: Short Interest ‚â•${minShort}% AND Daily Gain ‚â•+${minGain}%
                        </p>
                        <p style="color: #999;">
                            üí° Try lowering the thresholds or check back later!<br>
                            The market might just be having a calm day.
                        </p>
                    </div>
                `;
                return;
            }
            
            const avgGain = candidates.reduce((sum, s) => sum + s.dailyChange, 0) / candidates.length;
            const maxGain = Math.max(...candidates.map(s => s.dailyChange));
            const avgShort = candidates.reduce((sum, s) => sum + s.shortInterest, 0) / candidates.length;
            const avgRisk = candidates.reduce((sum, s) => sum + s.riskScore, 0) / candidates.length;
            
            let html = `
                <div class="results-header">
                    <h2>üöÄ Squeeze Candidates Found!</h2>
                    <p style="font-size: 1.2em; color: #666; margin: 10px 0;">
                        ${new Date().toLocaleString()}
                    </p>
                    <div class="summary-stats">
                        <div class="stat">
                            <span class="stat-value">${candidates.length}</span>
                            <span class="stat-label">Candidates</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${avgRisk.toFixed(1)}</span>
                            <span class="stat-label">Avg Risk Score</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">+${avgGain.toFixed(2)}%</span>
                            <span class="stat-label">Avg Gain</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">+${maxGain.toFixed(2)}%</span>
                            <span class="stat-label">Max Gain</span>
                        </div>
                    </div>
                </div>
            `;
            
            candidates.forEach((stock, idx) => {
                let riskClass, riskLabel, riskEmoji;
                if (stock.riskScore >= 90) {
                    riskClass = 'risk-extreme';
                    riskLabel = 'EXTREME';
                    riskEmoji = 'üî•üî•üî•';
                } else if (stock.riskScore >= 80) {
                    riskClass = 'risk-high';
                    riskLabel = 'HIGH';
                    riskEmoji = 'üöÄüöÄ';
                } else if (stock.riskScore >= 70) {
                    riskClass = 'risk-good';
                    riskLabel = 'GOOD';
                    riskEmoji = 'üí™';
                } else {
                    riskClass = 'risk-moderate';
                    riskLabel = 'MODERATE';
                    riskEmoji = '‚úÖ';
                }
                
                html += `
                    <div class="stock-card">
                        <div class="stock-header">
                            <div class="stock-title-row">
                                <button class="favorite-btn" onclick="addToFavorites('${stock.ticker}', '${stock.company}', 'squeeze')" title="Add to favorites">
                                    ‚≠ê
                                </button>
                                <div class="stock-ticker">#${idx + 1}. ${stock.ticker}</div>
                            </div>
                            <div class="risk-badge ${riskClass}">
                                ${stock.riskScore}/100 ${riskEmoji}
                            </div>
                        </div>
                        <div class="stock-company">${stock.company}</div>
                        
                        <div class="metrics-grid">
                            <div class="metric-section">
                                <h4>üìä Core Metrics</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Short Interest:</span>
                                    <span class="metric-value">${stock.shortInterest.toFixed(2)}%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Daily Gain:</span>
                                    <span class="metric-value" style="color: #10b981;">+${stock.dailyChange.toFixed(2)}%</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Price Move:</span>
                                    <span class="metric-value">$${stock.previousClose.toFixed(2)} ‚Üí $${stock.currentPrice.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="metric-section">
                                <h4>üìà Volume Analysis</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Vol:</span>
                                    <span class="metric-value">${stock.volume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Avg Volume:</span>
                                    <span class="metric-value">${stock.avgVolume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Volume Ratio:</span>
                                    <span class="metric-value">${stock.volumeRatio.toFixed(2)}x ${stock.volumeRatio >= 3 ? 'üî•' : stock.volumeRatio >= 2 ? 'üöÄ' : '‚úÖ'}</span>
                                </div>
                            </div>
                            
                            <div class="metric-section">
                                <h4>‚öôÔ∏è Squeeze Mechanics</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Float:</span>
                                    <span class="metric-value">${(stock.floatShares / 1000000).toFixed(1)}M</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Days to Cover:</span>
                                    <span class="metric-value">${stock.daysToCover.toFixed(2)} ${stock.daysToCover >= 5 ? 'üöÄ' : '‚úÖ'}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Market Cap:</span>
                                    <span class="metric-value">$${(stock.marketCap / 1000000).toFixed(1)}M</span>
                                </div>
                            </div>
                        </div>

                        <!-- News Section -->
                        <div class="metric-section" style="grid-column: 1 / -1; margin-top: 20px;">
                            <h4>üì∞ Latest News</h4>
                            ${stock.news && stock.news.length > 0 ? stock.news.map(item => {
                                const publishedDate = item.published ? new Date(item.published * 1000).toLocaleDateString() : 'Recently';
                                return `
                                    <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                                        <a href="${item.link}" target="_blank" style="color: var(--text-primary); text-decoration: none; font-weight: 500; display: block; margin-bottom: 3px; line-height: 1.4;">
                                            üìå ${item.title}
                                        </a>
                                        <span style="font-size: 0.85em; color: var(--text-secondary);">
                                            ${item.publisher} ‚Ä¢ ${publishedDate}
                                        </span>
                                    </div>
                                `;
                            }).join('') : '<p style="color: var(--text-secondary);">No recent news</p>'}
                        </div>

                        <div class="chart-container" id="chart-${stock.ticker}-squeeze-${idx}"></div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;

            // Create charts after HTML is rendered
            candidates.forEach((stock, idx) => {
                setTimeout(() => createChart(`chart-${stock.ticker}-squeeze-${idx}`, stock.ticker, 'daily'), 200 + (idx * 100));
            });
        }
        
        // Daily Plays Scanner
        async function startDailyScan() {
            if (isScanning) return;
            
            isScanning = true;
            document.getElementById('dailyButton').disabled = true;
            document.getElementById('dailyButton').textContent = '‚è≥ SCANNING...';
            document.getElementById('dailyLoading').classList.add('active');
            document.getElementById('dailyResults').classList.remove('active');
            
            try {
                const response = await fetch('/api/daily-plays', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})  // No filters needed
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayDailyResults(data.results);
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Error scanning: ' + error.message);
                console.error('Scan error:', error);
            } finally {
                isScanning = false;
                document.getElementById('dailyButton').disabled = false;
                document.getElementById('dailyButton').textContent = 'üìà SCAN ALL PATTERNS üéØ';
                document.getElementById('dailyLoading').classList.remove('active');
            }
        }
        
        function displayDailyResults(patterns) {
            const resultsDiv = document.getElementById('dailyResults');
            resultsDiv.classList.add('active');
            
            if (patterns.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h3>üéØ No Patterns Found Today</h3>
                        <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                            No stocks showed the 3-1 Strat pattern today
                        </p>
                        <p style="color: #999;">
                            üí° Market conditions may not be favorable right now.<br>
                            Check back later or try during market hours!
                        </p>
                    </div>
                `;
                return;
            }
            
            const bullishCount = patterns.filter(p => p.pattern.direction === 'bullish').length;
            const bearishCount = patterns.filter(p => p.pattern.direction === 'bearish').length;
            const totalVolume = patterns.reduce((sum, p) => sum + p.volume, 0);
            const avgVolume = totalVolume / patterns.length;
            
            let html = `
                <div class="results-header">
                    <h2>üéØ 3-1 Strat Patterns Found!</h2>
                    <p style="font-size: 1.2em; color: #666; margin: 10px 0;">
                        ${new Date().toLocaleString()}
                    </p>
                    <div class="summary-stats">
                        <div class="stat">
                            <span class="stat-value">${patterns.length}</span>
                            <span class="stat-label">Total Patterns</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" style="color: #10b981;">${bullishCount}</span>
                            <span class="stat-label">Bullish</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" style="color: #ef4444;">${bearishCount}</span>
                            <span class="stat-label">Bearish</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${(avgVolume / 1000000).toFixed(1)}M</span>
                            <span class="stat-label">Avg Volume</span>
                        </div>
                    </div>
                </div>
            `;
            
            patterns.forEach((stock, idx) => {
                const pattern = stock.pattern;
                const patternClass = pattern.direction === 'bullish' ? 'pattern-bullish' : 'pattern-bearish';
                const patternEmoji = pattern.direction === 'bullish' ? 'üìà' : 'üìâ';
                
                html += `
                    <div class="pattern-card">
                        <div class="stock-header">
                            <div class="stock-title-row">
                                <button class="favorite-btn" onclick="addToFavorites('${stock.ticker}', '${stock.company}', 'daily')" title="Add to favorites">
                                    ‚≠ê
                                </button>
                                <div class="stock-ticker">#${idx + 1}. ${stock.ticker}</div>
                            </div>
                            <div class="pattern-badge ${patternClass}">
                                ${patternEmoji} ${pattern.direction.toUpperCase()}
                            </div>
                        </div>
                        <div class="stock-company">${stock.company}</div>
                        
                        <div class="pattern-info">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">üìä Pattern Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #666;">3Ô∏è‚É£ Outside Bar (${pattern.three_candle.date}):</strong><br>
                                    High: $${pattern.three_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.three_candle.low.toFixed(2)}<br>
                                    Close: $${pattern.three_candle.close.toFixed(2)}
                                </div>
                                <div>
                                    <strong style="color: #666;">1Ô∏è‚É£ Inside Bar (${pattern.one_candle.date}):</strong><br>
                                    High: $${pattern.one_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.one_candle.low.toFixed(2)}<br>
                                    Open: $${pattern.one_candle.open.toFixed(2)}<br>
                                    Close: $${pattern.one_candle.close.toFixed(2)}
                                </div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>üí° Interpretation:</strong> 
                                The stock formed an outside bar (expansion) followed by an inside bar (consolidation). 
                                This ${pattern.direction} setup suggests potential breakout ${pattern.direction === 'bullish' ? 'above' : 'below'} 
                                the inside bar's range.
                            </div>
                        </div>
                        
                        <div class="metrics-grid" style="margin-top: 20px;">
                            <div class="metric-section">
                                <h4>üí∞ Price Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Price:</span>
                                    <span class="metric-value">$${stock.currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Daily Change:</span>
                                    <span class="metric-value" style="color: ${stock.dailyChange >= 0 ? '#10b981' : '#ef4444'};">
                                        ${stock.dailyChange >= 0 ? '+' : ''}${stock.dailyChange.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Market Cap:</span>
                                    <span class="metric-value">$${(stock.marketCap / 1000000).toFixed(1)}M</span>
                                </div>
                            </div>
                            
                            <div class="metric-section">
                                <h4>üìä Volume Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Vol:</span>
                                    <span class="metric-value">${stock.volume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Avg Volume:</span>
                                    <span class="metric-value">${stock.avgVolume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Volume Ratio:</span>
                                    <span class="metric-value">${(stock.volume / stock.avgVolume).toFixed(2)}x</span>
                                </div>
                            </div>
                        </div>

                        <!-- News Section -->
                        <div class="metric-section" style="grid-column: 1 / -1; margin-top: 20px;">
                            <h4>üì∞ Latest News</h4>
                            ${stock.news && stock.news.length > 0 ? stock.news.map(item => {
                                const publishedDate = item.published ? new Date(item.published * 1000).toLocaleDateString() : 'Recently';
                                return `
                                    <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                                        <a href="${item.link}" target="_blank" style="color: var(--text-primary); text-decoration: none; font-weight: 500; display: block; margin-bottom: 3px; line-height: 1.4;">
                                            üìå ${item.title}
                                        </a>
                                        <span style="font-size: 0.85em; color: var(--text-secondary);">
                                            ${item.publisher} ‚Ä¢ ${publishedDate}
                                        </span>
                                    </div>
                                `;
                            }).join('') : '<p style="color: var(--text-secondary);">No recent news</p>'}
                        </div>

                        <div class="chart-container" id="chart-${stock.ticker}-daily-${idx}"></div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            // Create charts after HTML is rendered
            patterns.forEach((stock, idx) => {
                setTimeout(() => createChart(`chart-${stock.ticker}-daily-${idx}`, stock.ticker, 'daily'), 200 + (idx * 100));
            });
        }
        
        // Weekly Plays Scanner
        async function startWeeklyScan() {
            if (isScanning) return;
            
            isScanning = true;
            document.getElementById('weeklyButton').disabled = true;
            document.getElementById('weeklyButton').textContent = '‚è≥ SCANNING...';
            document.getElementById('weeklyLoading').classList.add('active');
            document.getElementById('weeklyResults').classList.remove('active');
            
            try {
                const response = await fetch('/api/weekly-plays', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})  // No filters needed
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayWeeklyResults(data.results);
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Error scanning: ' + error.message);
                console.error('Weekly scan error:', error);
            } finally {
                isScanning = false;
                document.getElementById('weeklyButton').disabled = false;
                document.getElementById('weeklyButton').textContent = 'üìä SCAN WEEKLY PATTERNS üéØ';
                document.getElementById('weeklyLoading').classList.remove('active');
            }
        }
        
        function displayWeeklyResults(patterns) {
            const resultsDiv = document.getElementById('weeklyResults');
            resultsDiv.classList.add('active');
            
            if (patterns.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h3>üéØ No Weekly Patterns Found</h3>
                        <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                            No stocks showed the 3-1 Strat pattern on weekly timeframe
                        </p>
                        <p style="color: #999;">
                            üí° Weekly patterns are less common but signal larger moves.<br>
                            Check back next week!
                        </p>
                    </div>
                `;
                return;
            }
            
            const bullishCount = patterns.filter(p => p.pattern.direction === 'bullish').length;
            const bearishCount = patterns.filter(p => p.pattern.direction === 'bearish').length;
            const totalVolume = patterns.reduce((sum, p) => sum + p.volume, 0);
            const avgVolume = totalVolume / patterns.length;
            
            let html = `
                <div class="results-header">
                    <h2>üìä Weekly 3-1 Strat Patterns Found!</h2>
                    <p style="font-size: 1.2em; color: #666; margin: 10px 0;">
                        ${new Date().toLocaleString()}
                    </p>
                    <div class="summary-stats">
                        <div class="stat">
                            <span class="stat-value">${patterns.length}</span>
                            <span class="stat-label">Total Patterns</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" style="color: #10b981;">${bullishCount}</span>
                            <span class="stat-label">Bullish</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" style="color: #ef4444;">${bearishCount}</span>
                            <span class="stat-label">Bearish</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${(avgVolume / 1000000).toFixed(1)}M</span>
                            <span class="stat-label">Avg Weekly Vol</span>
                        </div>
                    </div>
                </div>
            `;
            
            patterns.forEach((stock, idx) => {
                const pattern = stock.pattern;
                const patternClass = pattern.direction === 'bullish' ? 'pattern-bullish' : 'pattern-bearish';
                const patternEmoji = pattern.direction === 'bullish' ? 'üìà' : 'üìâ';
                
                html += `
                    <div class="pattern-card">
                        <div class="stock-header">
                            <div class="stock-title-row">
                                <button class="favorite-btn" onclick="addToFavorites('${stock.ticker}', '${stock.company}', 'weekly')" title="Add to favorites">
                                    ‚≠ê
                                </button>
                                <div class="stock-ticker">#${idx + 1}. ${stock.ticker}</div>
                            </div>
                            <div class="pattern-badge ${patternClass}">
                                ${patternEmoji} ${pattern.direction.toUpperCase()} (WEEKLY)
                            </div>
                        </div>
                        <div class="stock-company">${stock.company}</div>
                        
                        <div class="pattern-info">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">üìä Weekly Pattern Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #666;">3Ô∏è‚É£ Outside Week (${pattern.three_candle.date}):</strong><br>
                                    High: $${pattern.three_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.three_candle.low.toFixed(2)}<br>
                                    Close: $${pattern.three_candle.close.toFixed(2)}
                                </div>
                                <div>
                                    <strong style="color: #666;">1Ô∏è‚É£ Inside Week (${pattern.one_candle.date}):</strong><br>
                                    High: $${pattern.one_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.one_candle.low.toFixed(2)}<br>
                                    Open: $${pattern.one_candle.open.toFixed(2)}<br>
                                    Close: $${pattern.one_candle.close.toFixed(2)}
                                </div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>üí° Interpretation:</strong> 
                                Weekly pattern! The stock formed an outside week (expansion) followed by an inside week (consolidation). 
                                This ${pattern.direction} setup on the weekly timeframe suggests potential for a multi-day/week move 
                                ${pattern.direction === 'bullish' ? 'above' : 'below'} the inside week's range.
                            </div>
                        </div>
                        
                        <div class="metrics-grid" style="margin-top: 20px;">
                            <div class="metric-section">
                                <h4>üí∞ Price Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Price:</span>
                                    <span class="metric-value">$${stock.currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Weekly Change:</span>
                                    <span class="metric-value" style="color: ${stock.weeklyChange >= 0 ? '#10b981' : '#ef4444'};">
                                        ${stock.weeklyChange >= 0 ? '+' : ''}${stock.weeklyChange.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Market Cap:</span>
                                    <span class="metric-value">$${(stock.marketCap / 1000000).toFixed(1)}M</span>
                                </div>
                            </div>
                            
                            <div class="metric-section">
                                <h4>üìä Volume Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">This Week Vol:</span>
                                    <span class="metric-value">${stock.volume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Avg Weekly Vol:</span>
                                    <span class="metric-value">${stock.avgVolume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Volume Ratio:</span>
                                    <span class="metric-value">${(stock.volume / stock.avgVolume).toFixed(2)}x</span>
                                </div>
                            </div>
                        </div>

                        <!-- News Section -->
                        <div class="metric-section" style="grid-column: 1 / -1; margin-top: 20px;">
                            <h4>üì∞ Latest News</h4>
                            ${stock.news && stock.news.length > 0 ? stock.news.map(item => {
                                const publishedDate = item.published ? new Date(item.published * 1000).toLocaleDateString() : 'Recently';
                                return `
                                    <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                                        <a href="${item.link}" target="_blank" style="color: var(--text-primary); text-decoration: none; font-weight: 500; display: block; margin-bottom: 3px; line-height: 1.4;">
                                            üìå ${item.title}
                                        </a>
                                        <span style="font-size: 0.85em; color: var(--text-secondary);">
                                            ${item.publisher} ‚Ä¢ ${publishedDate}
                                        </span>
                                    </div>
                                `;
                            }).join('') : '<p style="color: var(--text-secondary);">No recent news</p>'}
                        </div>

                        <div class="chart-container" id="chart-${stock.ticker}-weekly-${idx}"></div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;

            // Create charts after HTML is rendered
            patterns.forEach((stock, idx) => {
                setTimeout(() => createChart(`chart-${stock.ticker}-weekly-${idx}`, stock.ticker, 'weekly'), 200 + (idx * 100));
            });
        }
        
        // Hourly Plays Scanner
        async function startHourlyScan() {
            if (isScanning) return;
            
            isScanning = true;
            document.getElementById('hourlyButton').disabled = true;
            document.getElementById('hourlyButton').textContent = '‚è≥ SCANNING...';
            document.getElementById('hourlyLoading').classList.add('active');
            document.getElementById('hourlyResults').classList.remove('active');
            
            try {
                const response = await fetch('/api/hourly-plays', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayHourlyResults(data.results);
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Error scanning: ' + error.message);
                console.error('Hourly scan error:', error);
            } finally {
                isScanning = false;
                document.getElementById('hourlyButton').disabled = false;
                document.getElementById('hourlyButton').textContent = '‚è∞ SCAN HOURLY PATTERNS üéØ';
                document.getElementById('hourlyLoading').classList.remove('active');
            }
        }
        
        function displayHourlyResults(patterns) {
            const resultsDiv = document.getElementById('hourlyResults');
            resultsDiv.classList.add('active');
            
            if (patterns.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h3>üéØ No Hourly Patterns Found</h3>
                        <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                            No stocks showed the 3-1 Strat pattern on hourly timeframe right now
                        </p>
                        <p style="color: #999;">
                            ‚è∞ Hourly patterns change frequently - try again in an hour!
                        </p>
                    </div>
                `;
                return;
            }
            
            const bullishCount = patterns.filter(p => p.pattern.direction === 'bullish').length;
            const bearishCount = patterns.filter(p => p.pattern.direction === 'bearish').length;
            
            let html = `
                <div class="results-header">
                    <h2>‚è∞ Hourly 3-1 Strat Patterns Found!</h2>
                    <p style="font-size: 1.2em; color: #666; margin: 10px 0;">
                        ${new Date().toLocaleString()}
                    </p>
                    <div class="summary-stats">
                        <div class="stat">
                            <span class="stat-value">${patterns.length}</span>
                            <span class="stat-label">Total Patterns</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" style="color: #10b981;">${bullishCount}</span>
                            <span class="stat-label">Bullish</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" style="color: #ef4444;">${bearishCount}</span>
                            <span class="stat-label">Bearish</span>
                        </div>
                    </div>
                </div>
            `;
            
            patterns.forEach((stock, idx) => {
                const pattern = stock.pattern;
                const patternClass = pattern.direction === 'bullish' ? 'pattern-bullish' : 'pattern-bearish';
                const patternEmoji = pattern.direction === 'bullish' ? 'üìà' : 'üìâ';
                
                html += `
                    <div class="pattern-card">
                        <div class="stock-header">
                            <div class="stock-title-row">
                                <button class="favorite-btn" onclick="addToFavorites('${stock.ticker}', '${stock.company}', 'hourly')" title="Add to favorites">
                                    ‚≠ê
                                </button>
                                <div class="stock-ticker">#${idx + 1}. ${stock.ticker}</div>
                            </div>
                            <div class="pattern-badge ${patternClass}">
                                ${patternEmoji} ${pattern.direction.toUpperCase()} (HOURLY)
                            </div>
                        </div>
                        <div class="stock-company">${stock.company}</div>
                        
                        <div class="pattern-info">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">‚è∞ Hourly Pattern Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #666;">3Ô∏è‚É£ Outside Hour (${pattern.three_candle.date}):</strong><br>
                                    High: $${pattern.three_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.three_candle.low.toFixed(2)}<br>
                                    Close: $${pattern.three_candle.close.toFixed(2)}
                                </div>
                                <div>
                                    <strong style="color: #666;">1Ô∏è‚É£ Inside Hour (${pattern.one_candle.date}):</strong><br>
                                    High: $${pattern.one_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.one_candle.low.toFixed(2)}<br>
                                    Open: $${pattern.one_candle.open.toFixed(2)}<br>
                                    Close: $${pattern.one_candle.close.toFixed(2)}
                                </div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>üí° Interpretation:</strong> 
                                Hourly pattern! Quick intraday setup showing ${pattern.direction} consolidation after expansion.
                                Watch for breakout ${pattern.direction === 'bullish' ? 'above' : 'below'} the inside hour's range.
                            </div>
                        </div>
                        
                        <div class="metrics-grid" style="margin-top: 20px;">
                            <div class="metric-section">
                                <h4>üí∞ Price Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Price:</span>
                                    <span class="metric-value">$${stock.currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Hourly Change:</span>
                                    <span class="metric-value" style="color: ${stock.hourlyChange >= 0 ? '#10b981' : '#ef4444'};">
                                        ${stock.hourlyChange >= 0 ? '+' : ''}${stock.hourlyChange.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Market Cap:</span>
                                    <span class="metric-value">$${(stock.marketCap / 1000000).toFixed(1)}M</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" id="chart-${stock.ticker}-hourly-${idx}"></div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            // Create charts after HTML is rendered
            patterns.forEach((stock, idx) => {
                setTimeout(() => createChart(`chart-${stock.ticker}-hourly-${idx}`, stock.ticker, 'hourly'), 200 + (idx * 100));
            });
        }
        
        // Crypto Scanner
        async function startCryptoScan() {
            if (isScanning) return;
            
            isScanning = true;
            document.getElementById('cryptoButton').disabled = true;
            document.getElementById('cryptoButton').textContent = '‚è≥ SCANNING...';
            document.getElementById('cryptoLoading').classList.add('active');
            document.getElementById('cryptoResults').classList.remove('active');
            
            try {
                const response = await fetch('/api/crypto-plays', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayCryptoResults(data.results);
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Error scanning: ' + error.message);
                console.error('Crypto scan error:', error);
            } finally {
                isScanning = false;
                document.getElementById('cryptoButton').disabled = false;
                document.getElementById('cryptoButton').textContent = '‚Çø SCAN CRYPTO PATTERNS üöÄ';
                document.getElementById('cryptoLoading').classList.remove('active');
            }
        }
        
        function displayCryptoResults(patterns) {
            const resultsDiv = document.getElementById('cryptoResults');
            resultsDiv.classList.add('active');
            
            if (patterns.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h3>‚Çø No Crypto Patterns Found</h3>
                        <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                            No 3-1 Strat patterns found in BTC, ETH, XRP, SOL, DOGE, HYPE
                        </p>
                        <p style="color: #999;">
                            üí° Crypto patterns can form quickly - check back soon!
                        </p>
                    </div>
                `;
                return;
            }
            
            // Group by crypto
            const grouped = {};
            patterns.forEach(p => {
                if (!grouped[p.ticker]) grouped[p.ticker] = [];
                grouped[p.ticker].push(p);
            });
            
            let html = `
                <div class="results-header">
                    <h2>‚Çø Crypto 3-1 Strat Patterns Found!</h2>
                    <p style="font-size: 1.2em; color: #666; margin: 10px 0;">
                        ${new Date().toLocaleString()}
                    </p>
                    <div class="summary-stats">
                        <div class="stat">
                            <span class="stat-value">${patterns.length}</span>
                            <span class="stat-label">Total Patterns</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${Object.keys(grouped).length}</span>
                            <span class="stat-label">Cryptos</span>
                        </div>
                    </div>
                </div>
            `;
            
            patterns.forEach((crypto, idx) => {
                const pattern = crypto.pattern;
                const patternClass = pattern.direction === 'bullish' ? 'pattern-bullish' : 'pattern-bearish';
                const patternEmoji = pattern.direction === 'bullish' ? 'üìà' : 'üìâ';
                
                html += `
                    <div class="pattern-card">
                        <div class="stock-header">
                            <div class="stock-title-row">
                                <button class="favorite-btn" onclick="addToFavorites('${crypto.ticker}', '${crypto.company}', 'crypto')" title="Add to favorites">
                                    ‚≠ê
                                </button>
                                <div class="stock-ticker">#${idx + 1}. ${crypto.ticker}</div>
                            </div>
                            <div class="pattern-badge ${patternClass}">
                                ${patternEmoji} ${pattern.direction.toUpperCase()} (${crypto.timeframe.toUpperCase()})
                            </div>
                        </div>
                        <div class="stock-company">${crypto.company}</div>
                        
                        <div class="pattern-info">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">‚Çø ${crypto.timeframe} Pattern Details</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #666;">3Ô∏è‚É£ Outside Bar (${pattern.three_candle.date}):</strong><br>
                                    High: $${pattern.three_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.three_candle.low.toFixed(2)}<br>
                                    Close: $${pattern.three_candle.close.toFixed(2)}
                                </div>
                                <div>
                                    <strong style="color: #666;">1Ô∏è‚É£ Inside Bar (${pattern.one_candle.date}):</strong><br>
                                    High: $${pattern.one_candle.high.toFixed(2)}<br>
                                    Low: $${pattern.one_candle.low.toFixed(2)}<br>
                                    Open: $${pattern.one_candle.open.toFixed(2)}<br>
                                    Close: $${pattern.one_candle.close.toFixed(2)}
                                </div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>üí° Interpretation:</strong> 
                                ${crypto.timeframe} crypto pattern! ${pattern.direction.charAt(0).toUpperCase() + pattern.direction.slice(1)} setup 
                                suggests potential breakout ${pattern.direction === 'bullish' ? 'above' : 'below'} the consolidation range.
                                ${crypto.timeframe === 'Weekly' ? 'Weekly patterns can signal major multi-week moves!' : ''}
                            </div>
                        </div>
                        
                        <div class="metrics-grid" style="margin-top: 20px;">
                            <div class="metric-section">
                                <h4>üí∞ Price Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Price:</span>
                                    <span class="metric-value">$${crypto.currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">${crypto.timeframe} Change:</span>
                                    <span class="metric-value" style="color: ${crypto.change >= 0 ? '#10b981' : '#ef4444'};">
                                        ${crypto.change >= 0 ? '+' : ''}${crypto.change.toFixed(2)}%
                                    </span>
                                </div>
                                ${crypto.marketCap > 0 ? `
                                <div class="metric-item">
                                    <span class="metric-label">Market Cap:</span>
                                    <span class="metric-value">$${(crypto.marketCap / 1000000000).toFixed(2)}B</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="metric-section">
                                <h4>üìä Volume Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Vol:</span>
                                    <span class="metric-value">${crypto.volume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Avg Volume:</span>
                                    <span class="metric-value">${crypto.avgVolume.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" id="chart-${crypto.ticker}-crypto-${idx}"></div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            // Create charts after HTML is rendered
            patterns.forEach((crypto, idx) => {
                setTimeout(() => createChart(`chart-${crypto.ticker}-crypto-${idx}`, crypto.fullTicker, 'crypto'), 200 + (idx * 100));
            });
        }

        // ===== LEMONAI OPTIONS ANALYZER =====
        async function loadLemonAIStats() {
            try {
                const response = await fetch('/api/lemonai-stats', {
                    method: 'GET'
                });

                const data = await response.json();

                if (data.success && data.overall.total_trades > 0) {
                    // Show the stats panel
                    document.getElementById('lemonaiStatsPanel').style.display = 'block';

                    // Update overall stats
                    const overall = data.overall;
                    document.getElementById('statsWinRate').textContent = overall.win_rate + '%';
                    document.getElementById('statsWins').textContent = overall.wins;
                    document.getElementById('statsLosses').textContent = overall.losses;
                    document.getElementById('statsTotalTrades').textContent = overall.total_trades;

                    // Update pattern stats
                    if (data.by_pattern && data.by_pattern.length > 0) {
                        const patternHTML = data.by_pattern.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>${p.pattern}</span>
                                <span style="font-weight: bold;">
                                    ${p.win_rate}%
                                    <span style="opacity: 0.7; font-size: 0.9em;">(${p.wins}W/${p.losses}L)</span>
                                </span>
                            </div>
                        `).join('');
                        document.getElementById('statsPatternList').innerHTML = patternHTML;
                    }

                    // Update timeframe stats
                    if (data.by_timeframe && data.by_timeframe.length > 0) {
                        const timeframeHTML = data.by_timeframe.map(tf => `
                            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.3em; font-weight: bold;">${tf.win_rate}%</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">${tf.timeframe}</div>
                                <div style="font-size: 0.75em; opacity: 0.7;">${tf.wins}W/${tf.losses}L</div>
                            </div>
                        `).join('');
                        document.getElementById('statsTimeframeList').innerHTML = timeframeHTML;
                    }

                    // Update last updated time
                    const lastUpdated = new Date(data.last_updated).toLocaleString();
                    document.getElementById('statsLastUpdated').textContent = `Last updated: ${lastUpdated}`;
                } else {
                    // Hide stats panel if no data yet
                    document.getElementById('lemonaiStatsPanel').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading stats:', error);
                // Don't show error to user, just hide the panel
                document.getElementById('lemonaiStatsPanel').style.display = 'none';
            }
        }

        async function startLemonAIScan() {
            if (isScanning) return;

            isScanning = true;
            document.getElementById('lemonaiButton').disabled = true;
            document.getElementById('lemonaiButton').textContent = '‚è≥ ANALYZING...';
            document.getElementById('lemonaiLoading').classList.add('active');
            document.getElementById('lemonaiResults').classList.remove('active');

            try {
                const response = await fetch('/api/lemonai-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success) {
                    displayLemonAIResults(data.recommendations, data.cached, data.cache_age_days);
                    // Load stats after generating recommendations
                    loadLemonAIStats();
                } else {
                    alert('Error: ' + data.error);
                }

            } catch (error) {
                alert('Error analyzing: ' + error.message);
                console.error('LemonAI error:', error);
            } finally {
                isScanning = false;
                document.getElementById('lemonaiButton').disabled = false;
                document.getElementById('lemonaiButton').textContent = 'üîÑ REFRESH RECOMMENDATIONS NOW';
                document.getElementById('lemonaiLoading').classList.remove('active');
            }
        }

        function displayLemonAIResults(recommendations, cached = false, cacheAge = 0) {
            const resultsDiv = document.getElementById('lemonaiResults');
            resultsDiv.classList.add('active');

            if (recommendations.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h3>ü§ñ No Recommendations Available</h3>
                        <p style="font-size: 1.2em; color: #666; margin: 20px 0;">
                            LemonAI is analyzing patterns and will have recommendations ready soon!
                        </p>
                        <p style="color: #999;">
                            üí° Fresh plays are generated weekly. Check back in a few moments.
                        </p>
                    </div>
                `;
                return;
            }

            const avgConfidence = recommendations.reduce((sum, r) => sum + r.confidence, 0) / recommendations.length;

            // Cache status message
            const cacheMessage = cached && cacheAge > 0
                ? `<div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 10px 15px; border-radius: 8px; margin: 10px 0; font-size: 0.95em;">
                     üìã Cached (${cacheAge} min ago). Auto-refreshes in ${59 - cacheAge} min.
                   </div>`
                : `<div style="background: #e8f5e9; border: 1px solid #4CAF50; padding: 10px 15px; border-radius: 8px; margin: 10px 0; font-size: 0.95em;">
                     ‚ú® Fresh analysis! Auto-refreshes every hour.
                   </div>`;

            let html = `
                <div class="results-header">
                    <h2>ü§ñ AI Options Recommendations</h2>
                    <p style="font-size: 1.2em; color: #666; margin: 10px 0;">
                        ${new Date().toLocaleString()}
                    </p>
                    ${cacheMessage}
                    <div class="summary-stats">
                        <div class="stat">
                            <span class="stat-value">${recommendations.length}</span>
                            <span class="stat-label">Recommendations</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${avgConfidence.toFixed(0)}%</span>
                            <span class="stat-label">Avg Confidence</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${recommendations.filter(r => r.option_type === 'CALL').length}</span>
                            <span class="stat-label">Calls</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${recommendations.filter(r => r.option_type === 'PUT').length}</span>
                            <span class="stat-label">Puts</span>
                        </div>
                    </div>
                </div>
            `;

            // Compact table view with all contract details
            html += `
                <div style="overflow-x: auto; margin: 20px 0;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95em; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 16px 10px; text-align: left; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">#</th>
                                <th style="padding: 16px 10px; text-align: left; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">SYM</th>
                                <th style="padding: 16px 10px; text-align: left; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">MARKET</th>
                                <th style="padding: 16px 10px; text-align: left; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">CP</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">CONF</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">SPOT</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">BID/ASK</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">STRK</th>
                                <th style="padding: 16px 10px; text-align: left; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">EXP</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">VOL</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">OI</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">PREMS</th>
                                <th style="padding: 16px 10px; text-align: right; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">CHG%</th>
                                <th style="padding: 16px 10px; text-align: left; font-weight: bold; font-size: 0.95em; border-bottom: 2px solid #ddd;">FLOW</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Beginner-friendly card layout with prominent option pricing
            recommendations.forEach((rec, idx) => {
                const marketColor = rec.direction === 'bullish' ? '#10b981' : '#ef4444';
                const marketText = rec.direction === 'bullish' ? 'Bullish' : 'Bearish';
                const confidenceColor = rec.confidence >= 80 ? '#10b981' : rec.confidence >= 60 ? '#f59e0b' : '#ef4444';
                const contract = rec.contract_details || {};

                html += `
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <!-- Header: Stock & Confidence -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #f3f4f6;">
                            <div>
                                <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">Trade #${idx + 1}</div>
                                <div style="font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 4px;">${rec.ticker}</div>
                                <div style="font-size: 1.1em; color: #666;">${rec.company}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: ${confidenceColor}; color: white; padding: 12px 20px; border-radius: 8px; font-size: 1.8em; font-weight: bold; margin-bottom: 8px;">
                                    ${rec.confidence.toFixed(0)}%
                                </div>
                                <div style="font-size: 0.9em; color: #666;">AI Confidence</div>
                            </div>
                        </div>

                        <!-- Main Trade Info -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Left Column: The Trade -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white;">
                                <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 12px;">üìä THE TRADE</div>
                                <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 16px;">
                                    ${rec.option_type === 'CALL' ? 'üìà BUY CALL' : 'üìâ BUY PUT'}
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 0.85em; opacity: 0.8;">Strike Price</div>
                                    <div style="font-size: 1.6em; font-weight: bold;">$${rec.strike_price.toFixed(2)}</div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 0.85em; opacity: 0.8;">Expiration</div>
                                    <div style="font-size: 1.1em; font-weight: 600;">${contract.expiration || rec.expiration}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; margin-top: 12px;">
                                    <div style="font-size: 0.85em; opacity: 0.9;">Stock Currently Trading</div>
                                    <div style="font-size: 1.3em; font-weight: bold;">$${rec.current_price.toFixed(2)}</div>
                                </div>
                            </div>

                            <!-- Right Column: Option Pricing -->
                            <div style="background: #f0fdf4; border: 2px solid #10b981; padding: 20px; border-radius: 8px;">
                                <div style="font-size: 0.9em; color: #059669; font-weight: 600; margin-bottom: 12px;">üí∞ OPTION PRICING</div>

                                ${contract.bid && contract.ask ? `
                                    <div style="margin-bottom: 16px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #d1d5db;">
                                                <div style="font-size: 0.8em; color: #666; margin-bottom: 4px;">BID (Sell)</div>
                                                <div style="font-size: 1.4em; font-weight: bold; color: #ef4444;">$${contract.bid.toFixed(2)}</div>
                                            </div>
                                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #d1d5db;">
                                                <div style="font-size: 0.8em; color: #666; margin-bottom: 4px;">ASK (Buy)</div>
                                                <div style="font-size: 1.4em; font-weight: bold; color: #10b981;">$${contract.ask.toFixed(2)}</div>
                                            </div>
                                        </div>
                                        <div style="font-size: 0.85em; color: #666; font-style: italic; line-height: 1.4;">
                                            üí° You'll buy at the ASK price ($${contract.ask.toFixed(2)} √ó 100 shares = $${(contract.ask * 100).toFixed(2)} total cost)
                                        </div>
                                    </div>

                                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #d1d5db; margin-bottom: 12px;">
                                        <div style="font-size: 0.8em; color: #666; margin-bottom: 4px;">Spread</div>
                                        <div style="font-size: 1.1em; font-weight: 600;">$${contract.bid_ask_spread ? contract.bid_ask_spread.toFixed(2) : '0.00'}</div>
                                        <div style="font-size: 0.75em; color: #666; margin-top: 4px;">Tighter = Better</div>
                                    </div>

                                    ${contract.percent_change ? `
                                        <div style="background: ${contract.percent_change >= 0 ? '#dcfce7' : '#fee2e2'}; padding: 10px; border-radius: 6px;">
                                            <div style="font-size: 0.8em; color: #666; margin-bottom: 4px;">Today's Change</div>
                                            <div style="font-size: 1.3em; font-weight: bold; color: ${contract.percent_change >= 0 ? '#10b981' : '#ef4444'};">
                                                ${contract.percent_change > 0 ? '+' : ''}${contract.percent_change.toFixed(1)}%
                                            </div>
                                        </div>
                                    ` : ''}
                                ` : `
                                    <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 1px solid #f59e0b;">
                                        <div style="font-size: 0.9em; color: #92400e;">‚ö†Ô∏è Pricing data not available</div>
                                        <div style="font-size: 0.85em; color: #78350f; margin-top: 4px;">Check with your broker for current prices</div>
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Market Direction & Pattern -->
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <div style="font-size: 0.8em; color: #666; margin-bottom: 6px;">Market Direction</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: ${marketColor};">
                                        ${marketText === 'Bullish' ? '‚¨ÜÔ∏è ' : '‚¨áÔ∏è '}${marketText}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8em; color: #666; margin-bottom: 6px;">Pattern Detected</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: #374151;">${rec.pattern}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8em; color: #666; margin-bottom: 6px;">Options Flow</div>
                                    <div>
                                        ${rec.options_flow && rec.options_flow.has_pattern ?
                                            '<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.95em; font-weight: 600;">üî• 3-LEGS PATTERN</span>' :
                                          rec.options_flow && rec.options_flow.flow_score >= 40 ?
                                            '<span style="background: #f59e0b; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.95em; font-weight: 600;">‚ö° Active Flow</span>' :
                                            '<span style="color: #999; font-size: 0.95em;">No Pattern</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Why This Trade -->
                        <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1e40af; margin-bottom: 10px; font-size: 1.05em;">üß† WHY THIS TRADE?</div>
                            <div style="font-size: 0.95em; color: #374151; line-height: 1.7;">
                                ${rec.reasoning.split('\n').map(line => `<div style="margin-bottom: 6px;">‚Ä¢ ${line}</div>`).join('')}
                            </div>
                        </div>

                        <!-- News Section -->
                        ${rec.news && rec.news.length > 0 ? `
                            <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                                <div style="font-weight: bold; color: #92400e; margin-bottom: 12px; font-size: 1.05em;">üì∞ LATEST NEWS</div>
                                ${rec.news.slice(0, 3).map(item => {
                                    const publishedDate = item.published ? new Date(item.published * 1000).toLocaleDateString() : 'Recently';
                                    return `
                                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #fcd34d;">
                                            <a href="${item.link}" target="_blank" style="color: #1f2937; text-decoration: none; font-weight: 600; font-size: 0.95em; display: block; margin-bottom: 4px;">
                                                üìå ${item.title}
                                            </a>
                                            <div style="font-size: 0.85em; color: #6b7280;">
                                                ${item.publisher} ‚Ä¢ ${publishedDate}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}

                        <!-- Market Data -->
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 0.9em; color: #666; font-weight: 600; margin-bottom: 12px;">üìä MARKET DATA</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <div>
                                    <div style="font-size: 0.75em; color: #666; margin-bottom: 4px;">Volume</div>
                                    <div style="font-size: 1.1em; font-weight: 600;">${contract.volume ? contract.volume.toLocaleString() : 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666; margin-bottom: 4px;">Open Interest</div>
                                    <div style="font-size: 1.1em; font-weight: 600;">${contract.open_interest ? contract.open_interest.toLocaleString() : 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666; margin-bottom: 4px;">Premium Value</div>
                                    <div style="font-size: 1.1em; font-weight: 600;">${contract.premium_value ? '$' + (contract.premium_value / 1000).toFixed(1) + 'K' : 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #666; margin-bottom: 4px;">Source</div>
                                    <div style="font-size: 1.1em; font-weight: 600;">${rec.source}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Close the table (not actually used in card layout but keep for structure)
            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // Beginner-friendly disclaimer
            html += `
                <div style="background: linear-gradient(135deg, #fee2e2 0%, #fef3c7 100%); border: 3px solid #ef4444; padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <div style="font-size: 1.3em; font-weight: bold; color: #991b1b; margin-bottom: 12px;">
                        ‚ö†Ô∏è IMPORTANT: Options Trading Disclaimer
                    </div>
                    <div style="font-size: 1em; color: #7c2d12; line-height: 1.7;">
                        <strong>For beginners:</strong> Options are advanced financial instruments. These are AI-generated suggestions, NOT financial advice.
                        You can <strong>lose 100% of your investment</strong>. Only trade with money you can afford to lose.
                        Consider paper trading first to learn. Auto-refreshes hourly with latest market data.
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        // ===== VOLEMON AUTO-SCANNER =====
        let volemonInterval = null;
        let volemonCountdown = null;
        let volemonTimeLeft = 20 * 60; // 20 minutes in seconds
        let volemonStats = {
            totalScans: 0,
            lastScan: null,
            stocksFoundToday: 0
        };
        
        // Store all stocks found today
        let volemonStocksFound = [];

        // Load volemon stats from localStorage
        function loadVolemonStats() {
            const saved = localStorage.getItem('volemonStats');
            if (saved) {
                const data = JSON.parse(saved);
                const today = new Date().toDateString();
                if (data.date === today) {
                    volemonStats = data.stats;
                    volemonStocksFound = data.stocksFound || [];
                    updateVolemonStatsDisplay();
                    // Display any saved stocks from today
                    if (volemonStocksFound.length > 0) {
                        displayVolemonResults(volemonStocksFound, true);
                    }
                }
            }
        }

        function saveVolemonStats() {
            localStorage.setItem('volemonStats', JSON.stringify({
                date: new Date().toDateString(),
                stats: volemonStats,
                stocksFound: volemonStocksFound
            }));
        }

        function updateVolemonStatsDisplay() {
            document.getElementById('totalScans').textContent = volemonStats.totalScans;
            document.getElementById('lastScan').textContent = volemonStats.lastScan || 'Never';
            document.getElementById('stocksFound').textContent = volemonStocksFound.length;
        }

        function updateVolemonTimer() {
            const minutes = Math.floor(volemonTimeLeft / 60);
            const seconds = volemonTimeLeft % 60;
            const timerElement = document.getElementById('volemonTimer');
            if (timerElement) {
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function startVolemonCountdown() {
            if (volemonCountdown) clearInterval(volemonCountdown);
            
            volemonCountdown = setInterval(() => {
                volemonTimeLeft--;
                if (volemonTimeLeft < 0) {
                    volemonTimeLeft = 20 * 60;
                }
                updateVolemonTimer();
            }, 1000);
        }

        async function performVolemonScan() {
            console.log('üîä Volemon scanning...');
            
            const loadingDiv = document.getElementById('volemonLoading');
            const resultsDiv = document.getElementById('volemonResults');
            
            loadingDiv.classList.add('active');
            
            try {
                const response = await fetch('/api/volemon-scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ min_volume_multiple: 2.0 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    volemonStats.totalScans++;
                    volemonStats.lastScan = new Date().toLocaleTimeString();
                    
                    // Add scan timestamp to each stock
                    const timestamp = new Date().toLocaleTimeString();
                    const newStocks = data.results.map(stock => ({
                        ...stock,
                        foundAt: timestamp,
                        scanNumber: volemonStats.totalScans
                    }));
                    
                    // Add new stocks to the collection (avoid duplicates from same scan)
                    newStocks.forEach(newStock => {
                        const existingIndex = volemonStocksFound.findIndex(
                            s => s.ticker === newStock.ticker && s.scanNumber === newStock.scanNumber
                        );
                        if (existingIndex === -1) {
                            volemonStocksFound.unshift(newStock); // Add to beginning
                        }
                    });
                    
                    saveVolemonStats();
                    updateVolemonStatsDisplay();
                    displayVolemonResults(volemonStocksFound, false);
                }
            } catch (error) {
                console.error('Volemon scan error:', error);
            } finally {
                loadingDiv.classList.remove('active');
            }
        }

        function displayVolemonResults(stocks, isLoadingFromCache = false) {
            const resultsDiv = document.getElementById('volemonResults');
            resultsDiv.classList.add('active');
            
            if (stocks.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: var(--card-bg); border-radius: 15px; margin-top: 20px;">
                        <h3 style="font-size: 1.8em; margin-bottom: 15px;">üîä No Volume Spikes Found Yet</h3>
                        <p style="font-size: 1.1em; color: var(--text-secondary);">
                            Volemon is actively scanning every 20 minutes.
                        </p>
                        <p style="color: var(--text-secondary); opacity: 0.8; margin-top: 15px;">
                            üí° Stocks will appear here when volume spikes are detected!
                        </p>
                    </div>
                `;
                return;
            }
            
            // Group stocks by scan
            const stocksByScan = {};
            stocks.forEach(stock => {
                const scanKey = stock.scanNumber || 'Unknown';
                if (!stocksByScan[scanKey]) {
                    stocksByScan[scanKey] = [];
                }
                stocksByScan[scanKey].push(stock);
            });
            
            // Get unique count (avoid counting same stock multiple times)
            const uniqueTickers = [...new Set(stocks.map(s => s.ticker))];
            
            let html = `
                <div class="results-header">
                    <h2>üîä Volemon - Volume Monsters Detected Today!</h2>
                    <p style="opacity: 0.8; margin-top: 10px;">
                        ${isLoadingFromCache ? 'Showing stocks found today' : 'Updated: ' + new Date().toLocaleString()}
                    </p>
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-item">
                            <span class="stat-value">${uniqueTickers.length}</span>
                            <span class="stat-label">Unique Stocks</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${stocks.filter(s => s.volume_multiple >= 3).length}</span>
                            <span class="stat-label">3x+ Volume</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${stocks.length}</span>
                            <span class="stat-label">Total Detections</span>
                        </div>
                    </div>
                    ${!isLoadingFromCache ? `
                        <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; color: white; text-align: center; font-weight: bold;">
                            ‚ú® Latest scan completed! Scroll down to see newest results.
                        </div>
                    ` : ''}
                </div>
            `;
            
            stocks.forEach((stock, idx) => {
                const volColor = stock.volume_multiple >= 3 ? '#10b981' : '#8b5cf6';
                const isRecent = idx < 10 && !isLoadingFromCache; // Highlight recent finds
                
                html += `
                    <div class="stock-card" style="${isRecent ? 'border: 3px solid #10b981; animation: pulse 2s infinite;' : ''}">
                        <div class="stock-header">
                            <div class="header-left">
                                <button class="favorite-btn" onclick="addToFavorites('${stock.ticker}', '${stock.company}', 'volemon')" title="Add to favorites">
                                    ‚≠ê
                                </button>
                                <div>
                                    <div class="stock-ticker">
                                        ${isRecent ? 'üÜï ' : ''}#${idx + 1}. ${stock.ticker}
                                    </div>
                                    <div class="stock-company">${stock.company}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="badge" style="background: ${volColor}; color: white; padding: 8px 16px; border-radius: 25px; font-weight: bold; margin-bottom: 5px;">
                                    üîä ${stock.volume_multiple.toFixed(1)}x Volume
                                </div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.8;">
                                    Found: ${stock.foundAt || 'Earlier today'} ${stock.scanNumber ? `(Scan #${stock.scanNumber})` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-section">
                                <h4>üí∞ Price Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Price:</span>
                                    <span class="metric-value">$${stock.price.toFixed(2)}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Change:</span>
                                    <span class="metric-value" style="color: ${stock.change >= 0 ? '#10b981' : '#ef4444'};">
                                        ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Market Cap:</span>
                                    <span class="metric-value">$${(stock.market_cap / 1000000).toFixed(1)}M</span>
                                </div>
                            </div>
                            
                            <div class="metric-section">
                                <h4>üìä Volume Info</h4>
                                <div class="metric-item">
                                    <span class="metric-label">Current Vol:</span>
                                    <span class="metric-value">${stock.volume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Avg Vol:</span>
                                    <span class="metric-value">${stock.avg_volume.toLocaleString()}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Multiple:</span>
                                    <span class="metric-value" style="color: ${volColor}; font-weight: bold;">
                                        ${stock.volume_multiple.toFixed(2)}x
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: var(--settings-bg); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <strong style="color: #8b5cf6;">üîä Volume Analysis:</strong>
                            <p style="margin-top: 8px; color: var(--text-secondary);">
                                ${stock.ticker} was detected at <strong>${stock.volume_multiple.toFixed(1)}x</strong> its average volume at ${stock.foundAt || 'earlier today'}!
                                ${stock.volume_multiple >= 3 
                                    ? 'This is a significant spike that could indicate strong institutional or retail interest.' 
                                    : 'Increased volume may signal growing momentum or news-driven activity.'}
                            </p>
                        </div>
                        
                        <div class="chart-container" id="chart-${stock.ticker}-volemon-${idx}"></div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            // Create charts
            stocks.forEach((stock, idx) => {
                setTimeout(() => createChart(`chart-${stock.ticker}-volemon-${idx}`, stock.ticker, 'daily'), 200 + (idx * 100));
            });
        }
        
        function clearVolemonResults() {
            if (confirm('Are you sure you want to clear all Volemon results? They will start accumulating again from the next scan.')) {
                volemonStocksFound = [];
                saveVolemonStats();
                updateVolemonStatsDisplay();
                
                const resultsDiv = document.getElementById('volemonResults');
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: var(--card-bg); border-radius: 15px; margin-top: 20px;">
                        <h3 style="font-size: 1.8em; margin-bottom: 15px;">üîä Results Cleared!</h3>
                        <p style="font-size: 1.1em; color: var(--text-secondary);">
                            Volemon is still actively scanning every 20 minutes.
                        </p>
                        <p style="color: var(--text-secondary); opacity: 0.8; margin-top: 15px;">
                            üí° New stocks will appear here as they're detected!
                        </p>
                    </div>
                `;
            }
        }

        // Start Volemon on page load
        function startVolemonAutoScanner() {
            console.log('üîä Starting Volemon auto-scanner...');
            loadVolemonStats();
            
            // Initial scan
            performVolemonScan();
            
            // Set up 20-minute interval
            volemonInterval = setInterval(() => {
                performVolemonScan();
                volemonTimeLeft = 20 * 60;
            }, 20 * 60 * 1000);
            
            // Start countdown
            startVolemonCountdown();
        }

        // Initialize Volemon when page loads
        window.addEventListener('DOMContentLoaded', () => {
            startVolemonAutoScanner();
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (volemonInterval) clearInterval(volemonInterval);
            if (volemonCountdown) clearInterval(volemonCountdown);
        });
        
        // ===== USUALS AUTO-SCANNER =====
        let usualsInterval = null;
        let usualsCountdown = null;
        let usualsTimeLeft = 15 * 60; // 15 minutes in seconds
        let usualsStats = {
            totalScans: 0,
            lastScan: null,
            patternsFound: 0
        };
        
        const USUALS_TICKERS = ['SOFI', 'INTC', 'SPY', 'TSLA', 'COIN', 'CDE', 'PLTR', 'AAPL', 'BAC', 'NVDA', 'GOOGL', 'META', 'MSFT', 'UNH'];
        
        // Load usuals stats from localStorage
        function loadUsualsStats() {
            const saved = localStorage.getItem('usualsStats');
            if (saved) {
                const data = JSON.parse(saved);
                const today = new Date().toDateString();
                if (data.date === today) {
                    usualsStats = data.stats;
                    updateUsualsStatsDisplay();
                }
            }
        }
        
        function saveUsualsStats() {
            localStorage.setItem('usualsStats', JSON.stringify({
                date: new Date().toDateString(),
                stats: usualsStats
            }));
        }
        
        function updateUsualsStatsDisplay() {
            document.getElementById('usualsTotalScans').textContent = usualsStats.totalScans;
            document.getElementById('usualsLastScan').textContent = usualsStats.lastScan || 'Never';
            document.getElementById('usualsPatterns').textContent = usualsStats.patternsFound;
        }
        
        function updateUsualsTimer() {
            const minutes = Math.floor(usualsTimeLeft / 60);
            const seconds = usualsTimeLeft % 60;
            const timerElement = document.getElementById('usualsTimer');
            if (timerElement) {
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function startUsualsCountdown() {
            if (usualsCountdown) clearInterval(usualsCountdown);
            
            usualsCountdown = setInterval(() => {
                usualsTimeLeft--;
                if (usualsTimeLeft < 0) {
                    usualsTimeLeft = 15 * 60;
                }
                updateUsualsTimer();
            }, 1000);
        }
        
        async function performUsualsScan() {
            console.log('‚≠ê Usuals scanning...');
            
            const loadingDiv = document.getElementById('usualsLoading');
            const resultsDiv = document.getElementById('usualsResults');
            
            loadingDiv.classList.add('active');
            
            try {
                const response = await fetch('/api/usuals-scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tickers: USUALS_TICKERS })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    usualsStats.totalScans++;
                    usualsStats.lastScan = new Date().toLocaleTimeString();
                    
                    // Count patterns
                    let patternsCount = 0;
                    data.results.forEach(stock => {
                        if (stock.patterns) {
                            patternsCount += Object.values(stock.patterns).filter(p => p !== null).length;
                        }
                    });
                    usualsStats.patternsFound = patternsCount;
                    
                    saveUsualsStats();
                    updateUsualsStatsDisplay();
                    displayUsualsResults(data.results);
                }
            } catch (error) {
                console.error('Usuals scan error:', error);
            } finally {
                loadingDiv.classList.remove('active');
            }
        }
        
        function displayUsualsResults(stocks) {
            const resultsDiv = document.getElementById('usualsResults');
            resultsDiv.classList.add('active');
            
            if (stocks.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: var(--card-bg); border-radius: 15px; margin-top: 20px;">
                        <h3 style="font-size: 1.8em; margin-bottom: 15px;">‚≠ê Loading Usuals...</h3>
                        <p style="font-size: 1.1em; color: var(--text-secondary);">
                            First scan in progress...
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="results-header">
                    <h2>‚≠ê The Usuals - Real-Time Updates</h2>
                    <p style="opacity: 0.8; margin-top: 10px;">Updated: ${new Date().toLocaleString()}</p>
                </div>
            `;
            
            stocks.forEach((stock, idx) => {
                // Determine volume status
                const volRatio = stock.volume_ratio || 1;
                const volStatus = volRatio >= 1.5 ? 'HIGH' : volRatio >= 1.0 ? 'NORMAL' : 'LOW';
                const volColor = volRatio >= 1.5 ? '#10b981' : volRatio >= 1.0 ? '#f59e0b' : '#ef4444';
                
                // Check for patterns
                const patterns = stock.patterns || {};
                const hasPatterns = Object.values(patterns).some(p => p !== null);
                
                // Get news
                const news = stock.news || [];
                
                html += `
                    <div class="stock-card" style="${hasPatterns ? 'border-left: 5px solid #10b981;' : ''}">
                        <div class="stock-header">
                            <div class="header-left">
                                <button class="favorite-btn" onclick="addToFavorites('${stock.ticker}', '${stock.company}', 'usuals')" title="Add to favorites">
                                    ‚≠ê
                                </button>
                                <div>
                                    <div class="stock-ticker">${stock.ticker}</div>
                                    <div class="stock-company">${stock.company}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.4em; font-weight: bold; color: ${stock.change >= 0 ? '#10b981' : '#ef4444'};">
                                    $${stock.price.toFixed(2)}
                                </div>
                                <div style="color: ${stock.change >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">
                                    ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        
                        <!-- Volume Section -->
                        <div style="background: var(--settings-bg); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <h4 style="color: #f59e0b; margin-bottom: 5px;">üìä Volume Analysis</h4>
                                    <p style="color: var(--text-secondary); margin: 0;">
                                        Current: ${stock.volume.toLocaleString()} | Avg: ${stock.avg_volume.toLocaleString()}
                                    </p>
                                </div>
                                <div class="badge" style="background: ${volColor}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                                    ${volStatus} (${volRatio.toFixed(2)}x)
                                </div>
                            </div>
                        </div>
                        
                        <!-- Patterns Section -->
                        <div class="metrics-grid" style="margin-top: 15px;">
                            <div class="metric-section">
                                <h4>üìà Pattern Detection</h4>
                                ${patterns.daily ? `
                                    <div class="metric-item" style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                                        <span class="metric-label">Daily:</span>
                                        <span class="metric-value" style="color: #10b981;">
                                            ${patterns.daily.direction === 'bullish' ? 'üìà' : 'üìâ'} ${patterns.daily.type}
                                        </span>
                                    </div>
                                ` : '<div class="metric-item"><span class="metric-label">Daily:</span><span class="metric-value">No pattern</span></div>'}
                                
                                ${patterns.weekly ? `
                                    <div class="metric-item" style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                                        <span class="metric-label">Weekly:</span>
                                        <span class="metric-value" style="color: #10b981;">
                                            ${patterns.weekly.direction === 'bullish' ? 'üìà' : 'üìâ'} ${patterns.weekly.type}
                                        </span>
                                    </div>
                                ` : '<div class="metric-item"><span class="metric-label">Weekly:</span><span class="metric-value">No pattern</span></div>'}
                                
                                ${patterns.hourly ? `
                                    <div class="metric-item" style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                                        <span class="metric-label">Hourly:</span>
                                        <span class="metric-value" style="color: #10b981;">
                                            ${patterns.hourly.direction === 'bullish' ? 'üìà' : 'üìâ'} ${patterns.hourly.type}
                                        </span>
                                    </div>
                                ` : '<div class="metric-item"><span class="metric-label">Hourly:</span><span class="metric-value">No pattern</span></div>'}
                                
                                ${patterns.four_hour ? `
                                    <div class="metric-item" style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 5px;">
                                        <span class="metric-label">4-Hour:</span>
                                        <span class="metric-value" style="color: #10b981;">
                                            ${patterns.four_hour.direction === 'bullish' ? 'üìà' : 'üìâ'} ${patterns.four_hour.type}
                                        </span>
                                    </div>
                                ` : '<div class="metric-item"><span class="metric-label">4-Hour:</span><span class="metric-value">No pattern</span></div>'}
                            </div>
                            
                            <div class="metric-section">
                                <h4>üì∞ Latest News</h4>
                                ${news.length > 0 ? news.map(item => {
                                    const publishedDate = item.published ? new Date(item.published * 1000).toLocaleDateString() : 'Recently';
                                    return `
                                        <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                                            <a href="${item.link}" target="_blank" style="color: var(--text-primary); text-decoration: none; font-weight: 500; display: block; margin-bottom: 3px; line-height: 1.4;">
                                                üìå ${item.title}
                                            </a>
                                            <span style="font-size: 0.85em; color: var(--text-secondary);">
                                                ${item.publisher} ‚Ä¢ ${publishedDate}
                                            </span>
                                        </div>
                                    `;
                                }).join('') : '<p style="color: var(--text-secondary);">No recent news</p>'}
                            </div>
                        </div>
                        
                        <div class="chart-container" id="chart-${stock.ticker}-usuals-${idx}"></div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            // Create charts
            stocks.forEach((stock, idx) => {
                setTimeout(() => createChart(`chart-${stock.ticker}-usuals-${idx}`, stock.ticker, 'daily'), 200 + (idx * 100));
            });
        }
        
        // Start Usuals on page load
        function startUsualsAutoScanner() {
            console.log('‚≠ê Starting Usuals auto-scanner...');
            loadUsualsStats();
            
            // Initial scan
            performUsualsScan();
            
            // Set up 15-minute interval
            usualsInterval = setInterval(() => {
                performUsualsScan();
                usualsTimeLeft = 15 * 60;
            }, 15 * 60 * 1000);
            
            // Start countdown
            startUsualsCountdown();
        }
        
        // Initialize Usuals when page loads
        window.addEventListener('DOMContentLoaded', () => {
            startUsualsAutoScanner();
        });
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (usualsInterval) clearInterval(usualsInterval);
            if (usualsCountdown) clearInterval(usualsCountdown);
        });

        // ===== CHAT SYSTEM =====
        let chatPollingInterval = null;
        let lastMessageId = null;

        function toggleChat() {
            const chatPanel = document.getElementById('chatPanel');
            chatPanel.classList.toggle('active');

            if (chatPanel.classList.contains('active')) {
                // Load messages when opening
                loadChatMessages();
                // Scroll to bottom
                scrollChatToBottom();
                // Hide notification
                document.getElementById('chatNotification').style.display = 'none';
            }
        }

        async function sendMessage(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('Please sign in to send messages');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            try {
                const response = await fetch('/api/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.success) {
                    input.value = '';
                    loadChatMessages();
                    scrollChatToBottom();
                } else {
                    alert('‚ùå Failed to send message: ' + data.error);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('‚ùå Failed to send message');
            }
        }

        async function loadChatMessages() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/chat/messages');
                const data = await response.json();

                if (data.success) {
                    displayChatMessages(data.messages);

                    // Check for new messages
                    if (data.messages.length > 0) {
                        const latestId = data.messages[data.messages.length - 1].id;
                        if (lastMessageId && latestId !== lastMessageId) {
                            // New message arrived
                            const chatPanel = document.getElementById('chatPanel');
                            if (!chatPanel.classList.contains('active')) {
                                // Show notification if chat is closed
                                document.getElementById('chatNotification').style.display = 'flex';
                            }
                        }
                        lastMessageId = latestId;
                    }
                }
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function displayChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');

            if (!messages || messages.length === 0) {
                chatMessages.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>üëã Welcome to the community chat!</p>
                        <p style="font-size: 0.9em;">Be the first to say hello!</p>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = messages.map(msg => {
                const isOwn = currentUser && msg.email === currentUser.email;
                const time = new Date(msg.timestamp).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const avatar = msg.name.charAt(0).toUpperCase();

                return `
                    <div class="chat-message ${isOwn ? 'own' : ''}" style="position: relative;">
                        <div class="chat-message-header">
                            <div class="chat-message-avatar">${avatar}</div>
                            <span>${isOwn ? 'You' : msg.name}</span>
                            <span style="opacity: 0.6;">‚Ä¢ ${time}</span>
                            ${isOwn ? `<button onclick="deleteChatMessage('${msg.id}')" class="chat-delete-btn" style="margin-left: 8px; background: rgba(239, 68, 68, 0.8); color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em;">Delete</button>` : ''}
                        </div>
                        <div class="chat-message-bubble">
                            ${escapeHtml(msg.message)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollChatToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function startChatPolling() {
            // Poll for new messages every 3 seconds
            if (chatPollingInterval) clearInterval(chatPollingInterval);

            chatPollingInterval = setInterval(() => {
                if (currentUser) {
                    loadChatMessages();
                }
            }, 3000);
        }

        function stopChatPolling() {
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
        }

        async function deleteChatMessage(messageId) {
            if (!confirm('Delete this message?')) {
                return;
            }

            try {
                const response = await fetch(`/api/chat/message/${messageId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // Reload messages
                    loadChatMessages();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('‚ùå Failed to delete message');
            }
        }

        // ===== CHALLENGES =====
        let challengesChart = null;

        async function loadChallenges() {
            try {
                const response = await fetch('/api/challenges', { method: 'GET' });
                const data = await response.json();

                if (data.success) {
                    displayChallenges(data);
                } else {
                    console.error('Failed to load challenges:', data.error);
                    document.getElementById('multiWeekChallengeContent').innerHTML = `
                        <div style="text-align: center; color: #fca5a5;">
                            ‚ùå Failed to load challenges
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading challenges:', error);
                document.getElementById('multiWeekChallengeContent').innerHTML = `
                    <div style="text-align: center; color: #fca5a5;">
                        ‚ùå Error loading challenges
                    </div>
                `;
            }
        }

        function displayChallenges(data) {
            // Display Multi-Week Challenges
            if (data.multi_week && data.multi_week.length > 0) {
                let multiWeekHTML = '<div style="display: grid; gap: 15px;">';

                data.multi_week.forEach(challenge => {
                    multiWeekHTML += `
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px;">
                            <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 8px;">
                                ${challenge.title}
                            </div>
                            <div style="font-size: 1em; opacity: 0.95; margin-bottom: 12px; line-height: 1.5;">
                                ${challenge.description}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 12px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.8em; opacity: 0.85;">Duration</div>
                                    <div style="font-size: 1.1em; font-weight: bold;">${challenge.duration}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.8em; opacity: 0.85;">Starting</div>
                                    <div style="font-size: 1.1em; font-weight: bold;">${challenge.starting_amount}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.8em; opacity: 0.85;">Target</div>
                                    <div style="font-size: 1.1em; font-weight: bold;">${challenge.target}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.8em; opacity: 0.85;">Ends</div>
                                    <div style="font-size: 1.1em; font-weight: bold;">${challenge.end_date}</div>
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.85em; opacity: 0.9;">Reward</div>
                                <div style="font-size: 1.2em; font-weight: bold;">${challenge.reward}</div>
                            </div>
                        </div>
                    `;
                });

                multiWeekHTML += '</div>';
                document.getElementById('multiWeekChallengeContent').innerHTML = multiWeekHTML;
            }

            // Display Weekly Challenges
            if (data.weekly && data.weekly.length > 0) {
                let weeklyHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px;">';

                data.weekly.forEach(challenge => {
                    weeklyHTML += `
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">
                                ${challenge.title}
                            </div>
                            <div style="font-size: 0.95em; opacity: 0.9; margin-bottom: 10px; line-height: 1.4;">
                                ${challenge.description}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75em; opacity: 0.85;">Target</div>
                                    <div style="font-size: 1.1em; font-weight: bold;">${challenge.target}</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75em; opacity: 0.85;">Ends</div>
                                    <div style="font-size: 1.1em; font-weight: bold;">${challenge.end_date}</div>
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.8em; opacity: 0.9;">Reward</div>
                                <div style="font-size: 1.1em; font-weight: bold;">${challenge.reward}</div>
                            </div>
                        </div>
                    `;
                });

                weeklyHTML += '</div>';
                document.getElementById('weeklyChallengeContent').innerHTML = weeklyHTML;
            }

            // Display Progress
            if (data.progress && data.progress.length > 0) {
                let progressHTML = '<div style="display: grid; gap: 10px;">';
                data.progress.forEach(p => {
                    const statusColor = p.completed ? '#10b981' : '#f59e0b';
                    const statusIcon = p.completed ? '‚úÖ' : '‚è≥';
                    progressHTML += `
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${statusIcon} ${p.challenge_name}
                                    </div>
                                    <div style="color: #666; font-size: 0.9em;">
                                        ${p.progress} / ${p.target}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: ${statusColor}; font-weight: bold;">
                                        ${Math.min(100, (p.progress / p.target * 100)).toFixed(0)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                progressHTML += '</div>';
                document.getElementById('challengeProgressContent').innerHTML = progressHTML;
            }
        }

        // ===== LEMONADE STAND (DIVIDEND TRACKER) =====
        let dividendChart = null;

        async function loadDividendData() {
            try {
                const response = await fetch('/api/dividend-data', { method: 'GET' });
                const data = await response.json();

                if (data.success) {
                    displayDividendData(data);
                } else {
                    console.error('Failed to load dividend data:', data.error);
                    document.getElementById('dividendStocksList').innerHTML = `
                        <div style="text-align: center; color: #ef4444;">
                            ‚ùå Failed to load dividend data
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading dividend data:', error);
                document.getElementById('dividendStocksList').innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        ‚ùå Error loading dividend data
                    </div>
                `;
            }
        }

        function displayDividendData(data) {
            // Update income calculator
            if (data.avg_yield) {
                const monthlyIncome = (1000 * (data.avg_yield / 100) / 12);
                document.getElementById('monthlyIncome1k').textContent = `$${monthlyIncome.toFixed(2)}`;
                document.getElementById('avgYield').textContent = `${data.avg_yield.toFixed(2)}%`;
            }

            // Display top 10 dividend stocks
            if (data.stocks && data.stocks.length > 0) {
                let stocksHTML = '<div style="display: grid; gap: 12px;">';

                data.stocks.forEach((stock, idx) => {
                    const monthlyIncome = ((1000 / stock.price) * stock.annual_dividend / 12);
                    const bgColor = idx < 3 ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' : 'white';
                    const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '';

                    stocksHTML += `
                        <div style="background: ${bgColor}; padding: 15px; border-radius: 10px; border: 2px solid ${idx < 3 ? '#f59e0b' : '#e5e7eb'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${medal} ${stock.ticker} - ${stock.name}
                                    </div>
                                    <div style="color: #666; font-size: 0.95em; margin-bottom: 8px;">
                                        Price: $${stock.price.toFixed(2)} | Annual Dividend: $${stock.annual_dividend.toFixed(2)}
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                                        <div style="background: rgba(34, 197, 94, 0.15); padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.85em; color: #666;">Yield</div>
                                            <div style="font-size: 1.3em; font-weight: bold; color: #16a34a;">
                                                ${stock.yield.toFixed(2)}%
                                            </div>
                                        </div>
                                        <div style="background: rgba(59, 130, 246, 0.15); padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.85em; color: #666;">Monthly from $1k</div>
                                            <div style="font-size: 1.3em; font-weight: bold; color: #2563eb;">
                                                $${monthlyIncome.toFixed(2)}
                                            </div>
                                        </div>
                                        <div style="background: rgba(168, 85, 247, 0.15); padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.85em; color: #666;">Payout Frequency</div>
                                            <div style="font-size: 1.3em; font-weight: bold; color: #7c3aed;">
                                                ${stock.frequency}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                stocksHTML += '</div>';
                document.getElementById('dividendStocksList').innerHTML = stocksHTML;
            }

            // Create dividend chart
            if (data.stocks && data.stocks.length > 0) {
                createDividendChart(data.stocks);
            }

            // Display dividend news
            if (data.news && data.news.length > 0) {
                let newsHTML = '<div style="display: grid; gap: 12px;">';

                data.news.forEach(article => {
                    newsHTML += `
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ea580c;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 1.1em;">
                                üì∞ ${article.title}
                            </div>
                            <div style="color: #666; margin-bottom: 8px; line-height: 1.5;">
                                ${article.summary || 'No summary available'}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: #999;">
                                <span>${article.source}</span>
                                <span>${article.published}</span>
                            </div>
                            ${article.url ? `<a href="${article.url}" target="_blank" style="display: inline-block; margin-top: 10px; color: #ea580c; text-decoration: none; font-weight: bold;">Read More ‚Üí</a>` : ''}
                        </div>
                    `;
                });

                newsHTML += '</div>';
                document.getElementById('dividendNewsList').innerHTML = newsHTML;
            } else {
                document.getElementById('dividendNewsList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        üì∞ No dividend news available at the moment
                    </div>
                `;
            }
        }

        function createDividendChart(stocks) {
            const ctx = document.getElementById('dividendChart');

            if (dividendChart) {
                dividendChart.destroy();
            }

            const labels = stocks.map(s => s.ticker);
            const yields = stocks.map(s => s.yield);
            const colors = stocks.map((_, idx) =>
                idx < 3 ? '#f59e0b' : '#3b82f6'
            );

            dividendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Dividend Yield (%)',
                        data: yields,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Yield (%)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Dividend Yields Comparison'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
